<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

	<!-- Enable component scanning for RAG (Retrieval-Augmented Generation) services -->
	<!-- RAG services depend on PrincipalService, so scan must be in this child context -->
	<context:component-scan base-package="jp.aegif.nemaki.rag" />

	<!-- Enable component scanning for MCP (Model Context Protocol) services -->
	<!-- MCP services depend on PrincipalService and VectorSearchService, so scan must be in this child context -->
	<context:component-scan base-package="jp.aegif.nemaki.mcp" />

	<!-- Enable component scanning for API v1 resources (Jersey REST resources with Spring DI) -->
	<context:component-scan base-package="jp.aegif.nemaki.api.v1.resource" />

	<!-- Cache -->
	<bean id="nemakiCachePool" class="jp.aegif.nemaki.util.cache.impl.NemakiCachePoolImpl"
	init-method="init">
		<property name="propertyManager">
            <ref bean="springPropertyManager" />
        </property>
        <property name="repositoryInfoMap">
            <ref bean="repositoryInfoMap" />
        </property>
	</bean>


	<bean id="ContentService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.ContentService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="contentService" />
		</property>
	</bean>
	<bean id="contentService" class="jp.aegif.nemaki.businesslogic.impl.ContentServiceImpl">
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
		<property name="contentDaoService">
			<ref bean="ContentDaoService" />
		</property>
		<property name="renditionManager">
			<ref bean="RenditionManager" />
		</property>
		<property name="typeManager">
			<ref bean="TypeManager" />
		</property>
       <property name="propertyManager">
            <ref bean="propertyManager" />
        </property>
        <property name="solrUtil">
            <ref bean="solrUtil" />
        </property>
        <property name="nemakiCachePool">
            <ref bean="nemakiCachePool" />
        </property>
        <property name="webhookService">
            <ref bean="WebhookService" />
        </property>
	</bean>

	<!-- Webhook Service for webhook notifications -->
	<bean id="WebhookService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.WebhookService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="webhookService" />
		</property>
	</bean>
	<bean id="webhookService" class="jp.aegif.nemaki.businesslogic.impl.WebhookServiceImpl">
		<property name="contentService">
			<ref bean="ContentService" />
		</property>
		<property name="dispatcher">
			<ref bean="webhookDispatcher" />
		</property>
		<property name="webhookDaoService">
			<ref bean="WebhookDaoService" />
		</property>
	</bean>

	<!-- Webhook DAO Service for delivery log persistence -->
	<bean id="WebhookDaoService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.dao.WebhookDaoService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="webhookDaoService" />
		</property>
	</bean>
	<bean id="webhookDaoService" class="jp.aegif.nemaki.dao.impl.couch.WebhookDaoServiceImpl">
		<property name="connectorPool">
			<ref bean="connectorPool" />
		</property>
	</bean>

	<!-- Webhook Dispatcher - HTTP implementation for production -->
	<!-- Switch to noopWebhookDispatcher for testing/development -->
	<bean id="webhookDispatcher" class="jp.aegif.nemaki.webhook.HttpWebhookDispatcher">
		<!-- Optional: customize timeouts -->
		<!-- <property name="connectTimeout" value="10000" /> -->
		<!-- <property name="readTimeout" value="30000" /> -->
	</bean>

	<!-- No-op Webhook Dispatcher for testing/development -->
	<bean id="noopWebhookDispatcher" class="jp.aegif.nemaki.webhook.NoopWebhookDispatcher" />

	<bean id="PrincipalService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.PrincipalService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="principalService" />
		</property>
	</bean>
	<bean id="principalService" class="jp.aegif.nemaki.businesslogic.impl.PrincipalServiceImpl">
		<property name="principalDaoService">
			<ref bean="PrincipalDaoService" />
		</property>
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
	</bean>

	<bean id="TypeService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.TypeService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="typeService" />
		</property>
	</bean>
	<bean id="typeService" class="jp.aegif.nemaki.businesslogic.impl.TypeServiceImpl">
		<constructor-arg>
			<ref bean="contentDaoService" />
		</constructor-arg>
		<property name="typeManager">
			<ref bean="TypeManager" />
		</property>
	</bean>

	<!-- Text Extraction Service for full-text search (NemakiWare 3.0) -->
	<bean id="TextExtractionService" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.TextExtractionService</value>
			</list>
		</property>
		<property name="target">
			<ref bean="textExtractionService" />
		</property>
	</bean>
	<bean id="textExtractionService" class="jp.aegif.nemaki.businesslogic.impl.TextExtractionServiceImpl">
	</bean>

	<!-- Rendition builder -->
	<bean id="RenditionManager" class="org.springframework.aop.framework.ProxyFactoryBean">
		<property name="proxyInterfaces">
			<list>
				<value>jp.aegif.nemaki.businesslogic.rendition.RenditionManager</value>
			</list>
		</property>
		<property name="target">
			<ref bean="jodRenditionManager" />
		</property>
	</bean>
	<bean id="jodRenditionManager" class="jp.aegif.nemaki.businesslogic.rendition.impl.JodRenditionManagerImpl">
        <property name="propertyManager">
            <ref bean="propertyManager" />
        </property>
	</bean>
</beans>
