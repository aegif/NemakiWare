<?xml version="1.0" encoding="UTF-8"?>
<!-- This context file needs in another file: ContentService/PrincipalService/TypeService
	bean definition -->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:aop="http://www.springframework.org/schema/aop"
 xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <context:annotation-config />
	<context:component-scan base-package="jp.aegif.nemaki.patch" />
	<context:component-scan base-package="jp.aegif.nemaki.init" />

	<!-- 
		Phase 2: CMIS Post-Initializer (New Architecture)
		
		Uses InitializingBean to execute CMIS operations after all Spring services
		are fully initialized. This replaces the problematic init-method approach
		and ensures proper dependency resolution.
	-->
	<bean id="cmisPostInitializer" class="jp.aegif.nemaki.init.CMISPostInitializer">
		<property name="cmisPatchList">
			<list>
				<!-- CMIS-specific patches that require running services -->
				<bean class="jp.aegif.nemaki.patch.Patch_InitialFolderSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<bean class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<bean class="jp.aegif.nemaki.patch.Patch_RelationshipTypesSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
			</list>
		</property>
	</bean>

	<!-- 
		Legacy PatchService (Preserved for compatibility)
		
		NOTE: Database initialization (Phase 1) is now handled by DatabasePreInitializer
		This service focuses only on CMIS operations that may be invoked manually.
	-->
	<bean id="PatchService" class="jp.aegif.nemaki.patch.PatchService" init-method="applyPatchesOnStartup">
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
		<property name="connectorPool">
			<ref bean="connectorPool" />
		</property>
		<property name="couchdbUrl">
			<value>${db.couchdb.url}</value>
		</property>
		<property name="couchdbUsername">
			<value>${db.couchdb.auth.username}</value>
		</property>
		<property name="couchdbPassword">
			<value>${db.couchdb.auth.password}</value>
		</property>
		<property name="patchList">
			<list>
				<!-- Individual patches consolidated into initialization data -->
				<!-- Future patches can be added here when needed -->
				<!-- Re-enabled for proper initial data creation -->
				<!-- DEBUG: Using inline bean definition instead of ref to avoid bean resolution issues -->
				<bean class="jp.aegif.nemaki.patch.Patch_InitialFolderSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- Standard CMIS Views Patch - adds missing CMIS 1.1 specification views -->
				<bean class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- Relationship Types Setup Patch - registers standard relationship types -->
				<bean class="jp.aegif.nemaki.patch.Patch_RelationshipTypesSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
			</list>
		</property>
	</bean>

	<bean id="patchUtil" class="jp.aegif.nemaki.patch.PatchUtil">
		<property name="propertyManager">
			<ref bean="propertyManager" />
		</property>
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
		<property name="contentDaoService">
			<ref bean="ContentDaoService" />
		</property>
		<property name="contentService">
			<ref bean="ContentService" />
		</property>
		<property name="connectorPool">
			<ref bean="connectorPool" />
		</property>
		<property name="repositoryService">
			<ref bean="RepositoryService" />
		</property>
		<property name="typeService">
			<ref bean="TypeService" />
		</property>
		<property name="typeManager">
			<ref bean="TypeManager" />
		</property>
	</bean>

	<!-- Initial Folder Setup Patch Bean -->
	<bean id="patch_InitialFolderSetup" class="jp.aegif.nemaki.patch.Patch_InitialFolderSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<!-- Standard CMIS Views Patch Bean -->
	<bean id="patch_StandardCmisViews" class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<!-- Relationship Types Setup Patch Bean -->
	<bean id="patch_RelationshipTypesSetup" class="jp.aegif.nemaki.patch.Patch_RelationshipTypesSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

</beans>
