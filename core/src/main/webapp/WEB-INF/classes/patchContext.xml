<?xml version="1.0" encoding="UTF-8"?>
<!-- This context file needs in another file: ContentService/PrincipalService/TypeService
	bean definition -->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:aop="http://www.springframework.org/schema/aop"
 xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <context:annotation-config />
	<!-- Component scanning intentionally disabled for both jp.aegif.nemaki.patch and jp.aegif.nemaki.init -->
	<!-- All initialization beans (DatabasePreInitializer, CMISPostInitializer, PatchService) -->
	<!-- are registered as explicit XML bean definitions to ensure reliable ApplicationListener execution -->

	<!--
		Phase 1: Database Pre-Initializer (ApplicationListener Pattern)

		CRITICAL FIX (2025-11-10): Added explicit bean definition for DatabasePreInitializer
		to ensure it executes in the CHILD context after NemakiApplicationContextLoader.refresh()

		Uses ApplicationListener<ContextRefreshedEvent> pattern to execute AFTER child context
		is fully initialized, ensuring all property beans and connectorPool are available.

		@Order(1) ensures this runs BEFORE CMISPostInitializer (@Order(2))
	-->
	<bean id="databasePreInitializer" class="jp.aegif.nemaki.init.DatabasePreInitializer">
		<!-- All dependencies are @Autowired in the class itself -->
		<!-- PropertyManager, ConnectorPool injected automatically -->
	</bean>

	<!--
		Phase 2: CMIS Post-Initializer (New Architecture)

		CRITICAL FIX: Changed from InitializingBean to ContextRefreshedEvent
		Uses @EventListener to execute CMIS operations AFTER entire Spring context
		is fully initialized, ensuring TypeManager and all services are operational.
		This prevents "TYPES is empty" errors during patch execution.
	-->
	<bean id="cmisPostInitializer" class="jp.aegif.nemaki.init.CMISPostInitializer">
		<property name="cmisPatchList">
			<list>
				<!-- CRITICAL: System folder must be created first for other patches to work -->
				<bean class="jp.aegif.nemaki.patch.Patch_SystemFolderSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- Initial content setup: Sites, Technical Documents folders and CMIS spec PDF -->
				<!-- MUST run after SystemFolderSetup but before any caching initialization -->
				<bean class="jp.aegif.nemaki.patch.Patch_InitialContentSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- CMIS-specific patches that require running services -->
				<!-- CRITICAL FIX (2025-10-18): Patch_StandardCmisViews ENHANCED -->
				<!-- Now creates all 38 views from bedroom_init.dump specification -->
				<bean class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<bean class="jp.aegif.nemaki.patch.Patch_TestUserInitialization">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
			</list>
		</property>
	</bean>

	<!--
		PHASE 3: PatchService - System Property Initialization

		CRITICAL FIX (2025-11-11): FINAL ATTEMPT - CMISPostInitializer Pattern

		Previous attempts ALL FAILED:
		1. XML property injection (7 separate properties) → FAILED ❌
		2. Removed init-method (7 properties remain) → FAILED ❌
		3. Empty bean + @Autowired (0 properties) → FAILED ❌

		CORRECTED Pattern Analysis (verified by actual source code):
		- DatabasePreInitializer: 0 XML properties (empty bean) + field defaults (NO @Autowired) → WORKS ✅
		- CMISPostInitializer: 1 XML property (list) + NO @Autowired → WORKS ✅
		- PatchService: Testing CMISPostInitializer pattern - 1 XML property (list) + @Autowired

		KEY DISCOVERY: CMISPostInitializer has exactly 1 XML property containing a list.
		DatabasePreInitializer has NO Spring dependencies at all (only hardcoded strings).
		PatchService cannot use field defaults (needs Spring services).

		NEW HYPOTHESIS: Spring event multicaster requires AT LEAST 1 XML property for proper
		ApplicationListener registration. Testing CMISPostInitializer pattern with dummy list property.

		Execution order managed by @Order(3) annotation in PatchService.java.
	-->
	<bean id="patchService" class="jp.aegif.nemaki.patch.PatchService">
		<!-- Pattern matching CMISPostInitializer: 1 XML property (list) -->
		<!-- Dummy property required for ApplicationListener registration -->
		<property name="patchList">
			<list>
				<!-- Empty list - PatchService uses @Autowired for actual dependencies -->
			</list>
		</property>
	</bean>

	<bean id="patchUtil" class="jp.aegif.nemaki.patch.PatchUtil">
		<property name="propertyManager">
			<ref bean="propertyManager" />
		</property>
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
		<property name="contentDaoService">
			<ref bean="ContentDaoService" />
		</property>
		<property name="contentService">
			<ref bean="ContentService" />
		</property>
		<property name="connectorPool">
			<ref bean="connectorPool" />
		</property>
		<property name="repositoryService">
			<ref bean="RepositoryService" />
		</property>
		<property name="typeService">
			<ref bean="typeService" />
		</property>
		<property name="typeManager">
			<ref bean="typeManager" />
		</property>
	</bean>

	<!-- Individual Patch Bean Definitions for ServletContextListener access -->
	<!-- CRITICAL: These beans are also used by ServletContextListener for reliable patch execution -->

	<bean id="patch_SystemFolderSetup" class="jp.aegif.nemaki.patch.Patch_SystemFolderSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<bean id="patch_InitialContentSetup" class="jp.aegif.nemaki.patch.Patch_InitialContentSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<!-- CRITICAL FIX (2025-10-18): patch_StandardCmisViews ENHANCED to create all 38 views -->
	<bean id="patch_StandardCmisViews" class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<bean id="patch_TestUserInitialization" class="jp.aegif.nemaki.patch.Patch_TestUserInitialization">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

</beans>
