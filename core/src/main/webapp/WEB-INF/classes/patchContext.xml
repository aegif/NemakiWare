<?xml version="1.0" encoding="UTF-8"?>
<!-- This context file needs in another file: ContentService/PrincipalService/TypeService
	bean definition -->

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:aop="http://www.springframework.org/schema/aop"
 xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd
    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
    http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <context:annotation-config />
	<context:component-scan base-package="jp.aegif.nemaki.patch" />
	<!-- Component scanning for jp.aegif.nemaki.init intentionally disabled to prevent conflicts -->
	<!-- CMISPostInitializer is registered as explicit bean definition below instead -->

	<!--
		Phase 2: CMIS Post-Initializer (New Architecture)

		CRITICAL FIX: Changed from InitializingBean to ContextRefreshedEvent
		Uses @EventListener to execute CMIS operations AFTER entire Spring context
		is fully initialized, ensuring TypeManager and all services are operational.
		This prevents "TYPES is empty" errors during patch execution.
	-->
	<bean id="cmisPostInitializer" class="jp.aegif.nemaki.init.CMISPostInitializer">
		<property name="cmisPatchList">
			<list>
				<!-- CRITICAL: System folder must be created first for other patches to work -->
				<bean class="jp.aegif.nemaki.patch.Patch_SystemFolderSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- Initial content setup: Sites, Technical Documents folders and CMIS spec PDF -->
				<!-- MUST run after SystemFolderSetup but before any caching initialization -->
				<bean class="jp.aegif.nemaki.patch.Patch_InitialContentSetup">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<!-- CMIS-specific patches that require running services -->
				<bean class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
				<bean class="jp.aegif.nemaki.patch.Patch_TestUserInitialization">
					<property name="patchUtil">
						<ref bean="patchUtil" />
					</property>
				</bean>
			</list>
		</property>
	</bean>

	<!--
		PatchService Bean Definition - DISABLED

		CONFLICT RESOLUTION: Removed explicit bean definition to prevent conflicts with @Component annotation.
		PatchService is now registered via @Component annotation in PatchService.java class.

		This avoids bean registration conflicts and ensures proper initialization via component scanning.
		Properties are injected via @Autowired in the class itself.
	-->
	<!-- DISABLED: Bean definition conflicts with @Component annotation
	<bean id="PatchService" class="jp.aegif.nemaki.patch.PatchService" init-method="applyPatchesOnStartup">
		...
	</bean>
	-->

	<bean id="patchUtil" class="jp.aegif.nemaki.patch.PatchUtil">
		<property name="propertyManager">
			<ref bean="propertyManager" />
		</property>
		<property name="repositoryInfoMap">
			<ref bean="repositoryInfoMap" />
		</property>
		<property name="contentDaoService">
			<ref bean="ContentDaoService" />
		</property>
		<property name="contentService">
			<ref bean="ContentService" />
		</property>
		<property name="connectorPool">
			<ref bean="connectorPool" />
		</property>
		<property name="repositoryService">
			<ref bean="RepositoryService" />
		</property>
		<property name="typeService">
			<ref bean="TypeService" />
		</property>
		<property name="typeManager">
			<ref bean="TypeManager" />
		</property>
	</bean>

	<!-- Individual Patch Bean Definitions for ServletContextListener access -->
	<!-- CRITICAL: These beans are also used by ServletContextListener for reliable patch execution -->

	<bean id="patch_SystemFolderSetup" class="jp.aegif.nemaki.patch.Patch_SystemFolderSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<bean id="patch_InitialContentSetup" class="jp.aegif.nemaki.patch.Patch_InitialContentSetup">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<bean id="patch_StandardCmisViews" class="jp.aegif.nemaki.patch.Patch_StandardCmisViews">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

	<bean id="patch_TestUserInitialization" class="jp.aegif.nemaki.patch.Patch_TestUserInitialization">
		<property name="patchUtil">
			<ref bean="patchUtil" />
		</property>
	</bean>

</beans>
