# タイプ管理の整合性テスト

## テスト概要

このテストスイートは、カスタムタイプの作成、ドキュメントとの関連、タイプ削除の制約、プレビュー機能との連携を検証します。タイプ管理とドキュメント操作の整合性を確認します。

## テスト目的

- カスタムドキュメント型の作成と管理を確認
- カスタム型でのドキュメント作成を検証
- ドキュメント存在時のタイプ削除制約を確認
- カスタム型ドキュメントのプレビュー機能を検証
- ドキュメント削除後のタイプ削除を確認

## 前提条件

- NemakiWareサーバーが http://localhost:8080/core/ui/ で稼働していること
- admin:admin でログイン可能であること
- タイプ管理機能がUIで利用可能であること

## テストステップ詳細

### Step 1: カスタムドキュメント型の作成

**操作内容**:
1. 管理メニューからタイプ管理画面に遷移
2. 「新規タイプ」ボタンをクリック
3. タイプID（例: `test:managedType{uuid}`）を入力
4. 表示名を入力
5. ベースタイプとして「ドキュメント」を選択
6. プロパティ定義タブに切り替え
7. カスタムプロパティを追加（文字列型）
8. 作成ボタンをクリック

**期待結果**:
- カスタム型が正常に作成される
- タイプ管理テーブルに表示される
- プロパティ定義が保存される

**検証するCMIS概念**:
- TypeDefinition creation
- PropertyDefinition management
- Type mutability

---

### Step 2: カスタム型でドキュメントを作成

**操作内容**:
1. ドキュメント一覧画面に遷移
2. アップロードボタンをクリック
3. テストファイルを選択
4. タイプセレクターで作成したカスタム型を選択
5. カスタムプロパティに値を入力
6. アップロードを実行

**期待結果**:
- ドキュメントが正常にアップロードされる
- カスタム型が適用される
- カスタムプロパティの値が保存される

**検証するCMIS概念**:
- createDocument with custom type
- Type-document relationship

---

### Step 3: カスタム型の削除を試行（失敗を期待）

**操作内容**:
1. タイプ管理画面に遷移
2. 作成したカスタム型を選択
3. 削除ボタンをクリック
4. 確認ダイアログで承認

**期待結果**:
- 削除が失敗する
- エラーメッセージが表示される（「このタイプを使用しているドキュメントが存在します」など）
- カスタム型が削除されずに残る

**検証するCMIS概念**:
- Type deletion constraints
- Referential integrity
- CMIS exception handling

---

### Step 4: カスタム型ドキュメントのプレビュー

**操作内容**:
1. ドキュメント一覧画面に遷移
2. テストドキュメントを選択
3. プレビューボタンをクリック（または詳細画面でプレビュータブを選択）
4. プレビュー内容を確認
5. カスタムプロパティが表示されることを確認

**期待結果**:
- プレビューが正常に表示される
- ドキュメントのコンテンツが表示される
- カスタムプロパティが詳細パネルに表示される

**検証するCMIS概念**:
- getContentStream operation
- Property display for custom types

---

### Step 5: ドキュメントを削除してタイプを削除

**操作内容**:
1. ドキュメント一覧画面に遷移
2. テストドキュメントを選択
3. 削除ボタンをクリック
4. 完全削除を選択（アーカイブではなく）
5. タイプ管理画面に遷移
6. カスタム型を選択
7. 削除ボタンをクリック
8. 確認ダイアログで承認

**期待結果**:
- ドキュメントが正常に削除される
- カスタム型の削除が成功する
- タイプ管理テーブルからカスタム型が消える

**検証するCMIS概念**:
- deleteObject operation
- Type deletion after document removal
- Type lifecycle management

## タイプ管理の概念

### CMISタイプ階層
CMISは以下の基本タイプを定義しています：
- **cmis:document**: ドキュメント型の基底
- **cmis:folder**: フォルダ型の基底
- **cmis:relationship**: 関連型の基底
- **cmis:policy**: ポリシー型の基底
- **cmis:secondary**: セカンダリ型の基底

### タイプの可変性（Mutability）
- **作成可能**: 新しいタイプを作成できるか
- **更新可能**: 既存のタイプを更新できるか
- **削除可能**: タイプを削除できるか

### 削除制約
タイプを削除するには以下の条件を満たす必要があります：
- そのタイプを使用しているオブジェクトが存在しない
- 子タイプが存在しない
- タイプが削除可能としてマークされている

## トラブルシューティング

### タイプ作成が失敗する場合
- タイプIDが一意であるか確認
- 必須フィールドがすべて入力されているか確認
- 管理者権限でログインしているか確認

### プレビューが表示されない場合
- ドキュメントのコンテンツタイプがサポートされているか確認
- プレビュー機能がUIで実装されているか確認

### タイプ削除が失敗する場合
- そのタイプを使用しているドキュメントがすべて削除されているか確認
- アーカイブされたドキュメントも確認（完全削除が必要な場合がある）
- 子タイプが存在しないか確認
