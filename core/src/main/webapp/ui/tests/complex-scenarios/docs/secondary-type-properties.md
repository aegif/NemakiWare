# セカンダリ型とカスタムプロパティのテスト

## テスト概要

このテストスイートは、セカンダリ型（アスペクト）の作成、ドキュメントへの適用、プロパティ管理、および検索動作を検証します。セカンダリ型はドキュメントに追加のプロパティセットを付与する機能です。

## テスト目的

- セカンダリ型の作成と定義を確認
- ドキュメントへのセカンダリ型適用を検証
- セカンダリ型プロパティの値設定と検索を確認
- セカンダリ型の削除と検索結果への影響を検証

## 前提条件

- NemakiWareサーバーが http://localhost:8080/core/ui/ で稼働していること
- admin:admin でログイン可能であること
- タイプ管理機能がUIで利用可能であること

## テストステップ詳細

### Step 1: セカンダリ型の作成

**操作内容**:
1. 管理メニューからタイプ管理画面に遷移
2. 「新規タイプ」ボタンをクリック
3. タイプID（例: `test:secondaryType{uuid}`）を入力
4. ベースタイプとして「セカンダリ」を選択
5. プロパティ定義タブに切り替え
6. カスタムプロパティを追加（文字列型、検索可能フラグON）
7. 作成ボタンをクリック

**期待結果**:
- セカンダリ型が正常に作成される
- タイプ管理テーブルに表示される
- プロパティ定義が保存される

**検証するCMIS概念**:
- Secondary Type Definition (cmis:secondary base type)
- PropertyDefinition for secondary types

---

### Step 2: テストドキュメントの作成

**操作内容**:
1. ドキュメント一覧画面に遷移
2. アップロードボタンをクリック
3. テストファイルを選択
4. 標準のドキュメント型でアップロード

**期待結果**:
- ドキュメントが正常にアップロードされる
- ドキュメント一覧テーブルに表示される

**検証するCMIS概念**:
- createDocument operation

---

### Step 3: ドキュメントにセカンダリ型を適用

**操作内容**:
1. テストドキュメントを選択
2. プロパティ編集画面を開く
3. セカンダリ型セクションで作成したセカンダリ型を追加
4. セカンダリ型のプロパティに値を入力（例: `SecondaryValue_{uuid}`）
5. 保存ボタンをクリック

**期待結果**:
- セカンダリ型がドキュメントに適用される
- セカンダリ型のプロパティが表示される
- プロパティ値が保存される

**検証するCMIS概念**:
- addSecondaryTypeIds operation
- Secondary type property values

---

### Step 4: セカンダリ型プロパティで検索

**操作内容**:
1. 検索画面に遷移
2. 検索テキストにセカンダリ型プロパティの値を入力
3. 検索ボタンをクリック

**期待結果**:
- 検索結果にテストドキュメントが表示される
- セカンダリ型プロパティの値でフィルタリングが機能する

**検証するCMIS概念**:
- CMIS SQL Query with secondary type properties
- Solr indexing of secondary type properties

---

### Step 5: セカンダリ型を削除して検索動作を確認

**操作内容**:
1. テストドキュメントを選択
2. プロパティ編集画面を開く
3. セカンダリ型セクションから適用したセカンダリ型を削除
4. 保存ボタンをクリック
5. 検索画面に遷移
6. 元のセカンダリ型プロパティ値で検索

**期待結果**:
- セカンダリ型がドキュメントから削除される
- セカンダリ型のプロパティが表示されなくなる
- 元の値で検索してもドキュメントがヒットしない

**検証するCMIS概念**:
- removeSecondaryTypeIds operation
- Search index update after secondary type removal

## セカンダリ型の概念

### セカンダリ型とは
セカンダリ型（アスペクト）は、CMIS 1.1で導入された機能で、ドキュメントに追加のプロパティセットを動的に付与できます。

### プライマリ型との違い
- **プライマリ型**: ドキュメント作成時に指定、変更不可
- **セカンダリ型**: 作成後に追加・削除可能、複数適用可能

### 使用例
- タグ付け機能
- ワークフロー状態管理
- カスタムメタデータの追加

## トラブルシューティング

### セカンダリ型が選択できない場合
- タイプ管理でセカンダリ型が正しく作成されているか確認
- ベースタイプが「セカンダリ」になっているか確認

### プロパティ値が保存されない場合
- プロパティ定義の型と入力値が一致しているか確認
- 必須プロパティが入力されているか確認

### 検索結果が期待と異なる場合
- Solrのインデックス更新に時間がかかる場合がある
- プロパティの検索可能フラグがONになっているか確認
