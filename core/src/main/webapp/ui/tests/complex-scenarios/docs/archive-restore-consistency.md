# アーカイブと復元の整合性テスト

## テスト概要

このテストスイートは、ドキュメントのアーカイブ（ソフト削除）、復元、および完全削除の機能を検証します。アーカイブ後のドキュメントの状態、復元後のプロパティ保持、完全削除の動作を確認します。

## テスト目的

- ドキュメントのアーカイブ（ソフト削除）機能を確認
- アーカイブビュー（ゴミ箱）でのドキュメント表示を検証
- アーカイブからの復元機能を確認
- 復元後のプロパティと配置の整合性を検証
- 完全削除機能を確認

## 前提条件

- NemakiWareサーバーが http://localhost:8080/core/ui/ で稼働していること
- admin:admin でログイン可能であること
- アーカイブ機能がUIで利用可能であること

## テストステップ詳細

### Step 1: テストフォルダとドキュメントの作成

**操作内容**:
1. ドキュメント一覧画面に遷移
2. テストフォルダ（例: `test:archiveFolder{uuid}`）を作成
3. テストフォルダに移動
4. テストドキュメント（例: `test:archiveDoc{uuid}.txt`）をアップロード
5. ドキュメントのプロパティを記録（名前、作成日時、カスタムプロパティなど）

**期待結果**:
- フォルダとドキュメントが正常に作成される
- ドキュメントがフォルダ内に表示される

**検証するCMIS概念**:
- createFolder operation
- createDocument operation

---

### Step 2: ドキュメントをアーカイブ

**操作内容**:
1. テストドキュメントを選択
2. 削除ボタンまたはアーカイブボタンをクリック
3. アーカイブ（ソフト削除）を選択
4. 確認ダイアログで承認

**期待結果**:
- ドキュメントがアーカイブされる
- 元のフォルダからドキュメントが消える
- 成功メッセージが表示される

**検証するCMIS概念**:
- Soft delete / Archive operation
- Object state change

---

### Step 3: アーカイブビューでドキュメントを確認

**操作内容**:
1. アーカイブビュー（ゴミ箱）に移動
2. アーカイブされたドキュメントを検索
3. ドキュメントのプロパティを確認

**期待結果**:
- アーカイブビューにドキュメントが表示される
- ドキュメントのプロパティが保持されている
- アーカイブ日時が記録されている

**検証するCMIS概念**:
- Archive view / Trash functionality
- Property preservation in archive

---

### Step 4: ドキュメントを復元

**操作内容**:
1. アーカイブビューでテストドキュメントを選択
2. 復元ボタンをクリック
3. 復元先を確認（元のフォルダまたは指定フォルダ）
4. 復元を実行

**期待結果**:
- ドキュメントが復元される
- アーカイブビューからドキュメントが消える
- 成功メッセージが表示される

**検証するCMIS概念**:
- Restore from archive operation
- Object state restoration

---

### Step 5: 復元後の整合性を確認

**操作内容**:
1. 元のテストフォルダに移動
2. 復元されたドキュメントを確認
3. ドキュメントのプロパティを確認（名前、作成日時、カスタムプロパティなど）
4. コンテンツを確認

**期待結果**:
- ドキュメントが元のフォルダに存在する
- すべてのプロパティが復元前と同じ
- コンテンツが保持されている
- バージョン履歴が保持されている（該当する場合）

**検証するCMIS概念**:
- Property preservation after restore
- Content stream preservation
- Version history preservation

---

### Step 6: アーカイブして完全削除

**操作内容**:
1. テストドキュメントを再度アーカイブ
2. アーカイブビューに移動
3. テストドキュメントを選択
4. 完全削除ボタンをクリック
5. 確認ダイアログで承認

**期待結果**:
- ドキュメントが完全に削除される
- アーカイブビューからもドキュメントが消える
- 復元不可能になる

**検証するCMIS概念**:
- Permanent delete operation
- Object removal from repository

## アーカイブ機能の概念

### ソフト削除 vs ハード削除
- **ソフト削除（アーカイブ）**: ドキュメントを非表示にするが、復元可能
- **ハード削除（完全削除）**: ドキュメントを完全に削除、復元不可能

### アーカイブの利点
- 誤削除からの保護
- 監査証跡の保持
- コンプライアンス要件への対応

### 復元の動作
- 元のフォルダが存在する場合: 元の場所に復元
- 元のフォルダが削除されている場合: ルートフォルダまたは指定場所に復元

## トラブルシューティング

### アーカイブが失敗する場合
- ドキュメントへの削除権限があるか確認
- ドキュメントがチェックアウト中でないか確認

### アーカイブビューが表示されない場合
- 管理者権限でログインしているか確認
- UIの実装状態を確認

### 復元が失敗する場合
- 復元先フォルダへの書き込み権限があるか確認
- 同名のドキュメントが既に存在しないか確認

### 完全削除後もドキュメントが表示される場合
- ページをリロードして最新状態を確認
- Solrインデックスの更新を待つ
