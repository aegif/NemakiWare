# バージョンとプロパティ履歴の整合性テスト

## テスト概要

このテストスイートは、ドキュメントのバージョン管理とプロパティ値の履歴の整合性を検証します。複数バージョンの作成、バージョン履歴の確認、バージョン削除後のロールバック動作を確認します。

## テスト目的

- 複数バージョンの作成と管理を確認
- 各バージョンのプロパティ値の独立性を検証
- バージョン履歴の表示と操作を確認
- バージョン削除後のロールバック動作を検証
- ロールバック後のコンテンツとプロパティの整合性を確認

## 前提条件

- NemakiWareサーバーが http://localhost:8080/core/ui/ で稼働していること
- admin:admin でログイン可能であること
- バージョン管理機能がUIで利用可能であること

## テストステップ詳細

### Step 1: 初期ドキュメントの作成（Version 1.0）

**操作内容**:
1. ドキュメント一覧画面に遷移
2. アップロードボタンをクリック
3. テストファイル（内容: `Version 1.0 Content`）を選択
4. ドキュメント名（例: `test:versionDoc{uuid}.txt`）を入力
5. アップロードを実行

**期待結果**:
- ドキュメントが正常にアップロードされる
- バージョンラベルが「1.0」になる
- ドキュメント一覧テーブルに表示される

**検証するCMIS概念**:
- createDocument operation
- Initial version creation (1.0)

---

### Step 2: チェックアウトしてVersion 2.0を作成

**操作内容**:
1. テストドキュメントを選択
2. チェックアウトボタンをクリック
3. PWC（作業中）状態を確認
4. 新しいコンテンツ（`Version 2.0 Content`）でチェックイン
5. チェックインモーダルでメジャーバージョンを選択

**期待結果**:
- チェックアウトが成功し、PWCタグが表示される
- チェックインが成功する
- バージョンラベルが「2.0」になる

**検証するCMIS概念**:
- checkOut operation
- PWC (Private Working Copy) creation
- checkIn with major version

---

### Step 3: Version 3.0を作成

**操作内容**:
1. テストドキュメントを選択
2. チェックアウトボタンをクリック
3. 新しいコンテンツ（`Version 3.0 Content`）でチェックイン
4. チェックインモーダルでメジャーバージョンを選択

**期待結果**:
- チェックインが成功する
- バージョンラベルが「3.0」になる
- 3つのバージョンが存在する

**検証するCMIS概念**:
- Multiple version creation
- Version series management

---

### Step 4: バージョン履歴の確認

**操作内容**:
1. テストドキュメントの詳細画面を開く
2. バージョン履歴タブまたはセクションに移動
3. すべてのバージョン（1.0, 2.0, 3.0）が表示されることを確認
4. 各バージョンのプロパティ（作成日時、作成者など）を確認

**期待結果**:
- バージョン履歴に3つのバージョンが表示される
- 各バージョンのメタデータが正しく表示される
- 最新バージョン（3.0）が現在のバージョンとして表示される

**検証するCMIS概念**:
- getAllVersions operation
- Version series navigation

---

### Step 5: 最新バージョンを削除してロールバック

**操作内容**:
1. バージョン履歴でVersion 3.0を選択
2. 削除ボタンをクリック
3. 削除を確認
4. ドキュメントの現在のバージョンを確認

**期待結果**:
- Version 3.0が削除される
- ドキュメントがVersion 2.0にロールバックされる
- バージョン履歴に2つのバージョン（1.0, 2.0）が表示される

**検証するCMIS概念**:
- deleteObject (version deletion)
- Automatic rollback to previous version

---

### Step 6: ロールバック後のコンテンツ確認

**操作内容**:
1. テストドキュメントのコンテンツを表示
2. コンテンツがVersion 2.0の内容（`Version 2.0 Content`）であることを確認
3. プロパティがVersion 2.0の値であることを確認

**期待結果**:
- コンテンツがVersion 2.0の内容と一致する
- プロパティ値がVersion 2.0の値と一致する
- ロールバックが正常に機能している

**検証するCMIS概念**:
- Content stream persistence per version
- Property value persistence per version

## バージョン管理の概念

### CMISバージョンモデル
CMISは以下のバージョン管理機能を提供します：
- **メジャーバージョン**: 1.0, 2.0, 3.0...
- **マイナーバージョン**: 1.1, 1.2, 2.1...
- **PWC**: チェックアウト中の作業コピー

### バージョンシリーズ
同じドキュメントのすべてのバージョンは「バージョンシリーズ」として管理されます。各バージョンは独立したオブジェクトIDを持ちますが、同じバージョンシリーズIDを共有します。

### チェックアウト/チェックイン
- **チェックアウト**: ドキュメントをロックし、PWCを作成
- **チェックイン**: PWCを新しいバージョンとして確定
- **チェックアウトキャンセル**: PWCを破棄し、ロックを解除

## トラブルシューティング

### チェックアウトが失敗する場合
- ドキュメントが既にチェックアウトされていないか確認
- 書き込み権限があるか確認

### バージョン履歴が表示されない場合
- ドキュメントがバージョン管理可能な型か確認
- UIの実装状態を確認

### ロールバック後のコンテンツが期待と異なる場合
- 各バージョンのコンテンツが正しく保存されているか確認
- キャッシュをクリアして再確認
