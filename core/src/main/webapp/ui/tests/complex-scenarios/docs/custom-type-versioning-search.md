# カスタム型・バージョン管理・検索の整合性テスト

## テスト概要

このテストスイートは、カスタムドキュメント型の作成から、必須プロパティの検証、検索フィルタリング、バージョン管理までの完全なワークフローを検証します。

## テスト目的

- カスタム型定義とプロパティ定義の正常動作を確認
- 必須プロパティのバリデーション機能を検証
- カスタムプロパティによる検索フィルタリングの動作を確認
- バージョン管理とプロパティ値の整合性を検証
- バージョン削除後の検索動作の変化を確認

## 前提条件

- NemakiWareサーバーが http://localhost:8080/core/ui/ で稼働していること
- admin:admin でログイン可能であること
- タイプ管理機能がUIで利用可能であること

## テストステップ詳細

### Step 1: カスタムドキュメント型の作成

**操作内容**:
1. 管理メニューからタイプ管理画面に遷移
2. 「新規タイプ」ボタンをクリック
3. タイプID（例: `test:searchDoc{uuid}`）を入力
4. 表示名を入力
5. ベースタイプとして「ドキュメント」を選択
6. プロパティ定義タブに切り替え
7. 必須プロパティを追加（文字列型、必須フラグON）
8. 検索可能プロパティを追加（文字列型、検索可能フラグON）
9. 作成ボタンをクリック

**期待結果**:
- カスタム型が正常に作成される
- タイプ管理テーブルに新しい型が表示される
- 成功メッセージが表示される

**検証するCMIS概念**:
- TypeDefinition の作成
- PropertyDefinition の定義（required, queryable フラグ）

---

### Step 2: カスタム型でドキュメントを作成

**操作内容**:
1. ドキュメント一覧画面に遷移
2. アップロードボタンをクリック
3. テストファイルを選択
4. タイプセレクターでカスタム型を選択
5. 必須プロパティに値を入力
6. 検索可能プロパティに初期値（例: `InitialValue_{uuid}`）を入力
7. アップロードボタンをクリック

**期待結果**:
- ドキュメントが正常にアップロードされる
- ドキュメント一覧テーブルに表示される
- カスタムプロパティの値が保存される

**検証するCMIS概念**:
- createDocument with custom type
- Property value persistence

---

### Step 3: カスタムプロパティで検索

**操作内容**:
1. 検索画面に遷移
2. 検索テキストに初期値を入力
3. タイプセレクターでカスタム型を選択（利用可能な場合）
4. 検索ボタンをクリック

**期待結果**:
- 検索結果にテストドキュメントが表示される
- カスタムプロパティの値でフィルタリングが機能する

**検証するCMIS概念**:
- CMIS SQL Query with custom property predicates
- Solr indexing of custom properties

---

### Step 4: プロパティ値を更新して検索結果の変化を確認

**操作内容**:
1. ドキュメント一覧画面に遷移
2. テストドキュメントをクリック
3. プロパティタブに切り替え
4. 検索可能プロパティの値を更新（例: `UpdatedValue_{uuid}`）
5. 保存ボタンをクリック
6. 検索画面に遷移
7. 元の初期値で検索

**期待結果**:
- プロパティ値が正常に更新される
- 元の値で検索してもドキュメントがヒットしない
- 新しい値で検索するとドキュメントがヒットする

**検証するCMIS概念**:
- updateProperties operation
- Solr re-indexing after property update

---

### Step 5: 新バージョンを作成してプロパティ値を復元

**操作内容**:
1. ドキュメント一覧画面に遷移
2. テストドキュメントのチェックアウトボタンをクリック
3. PWC（作業中）状態を確認
4. チェックインボタンをクリック
5. チェックインモーダルで検索可能プロパティを元の値に復元
6. チェックインを実行

**期待結果**:
- チェックアウトが成功し、PWCタグが表示される
- チェックインが成功し、新バージョンが作成される
- 元の値で検索するとドキュメントがヒットする

**検証するCMIS概念**:
- checkOut / checkIn operations
- PWC (Private Working Copy) management
- Version series creation

---

### Step 6: 最新バージョンを削除して検索動作を確認

**操作内容**:
1. ドキュメント詳細画面でバージョン履歴を開く
2. 最新バージョンの削除ボタンをクリック
3. 削除を確認
4. 検索画面に遷移
5. 復元した値で検索

**期待結果**:
- 最新バージョンが削除される
- ドキュメントが前のバージョンにロールバックされる
- 前のバージョンのプロパティ値（更新後の値）が有効になる
- 復元した値で検索してもドキュメントがヒットしない

**検証するCMIS概念**:
- deleteObject (version deletion)
- Version rollback behavior
- Search index update after version deletion

## トラブルシューティング

### テストがスキップされる場合
- タイプ管理メニューが表示されない: 管理者権限でログインしているか確認
- 新規タイプボタンが見つからない: UIの実装状態を確認

### 検索結果が期待と異なる場合
- Solrのインデックス更新に時間がかかる場合がある
- `waitForTimeout` の値を増やして再試行

### バージョン操作が失敗する場合
- ドキュメントが既にチェックアウトされていないか確認
- 権限設定を確認
