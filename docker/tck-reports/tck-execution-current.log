==========================================
NemakiWare TCK Test Execution
==========================================
✓ Found core container: docker-core-1
✓ Docker containers are running
Testing connectivity to NemakiWare core service...
✓ Core service is accessible
Preparing TCK configuration for Docker environment...
Using existing DockerTckRunner.java (no overwrite needed)
Building TCK test package...
Compiling comprehensive TCK test classes...
Running comprehensive query testing and fixes...
=== Comprehensive CMIS Query Testing ===
Using core container: docker-core-1
1. Fixing Solr connectivity and repository ID issues:
=== Fixing Solr Connectivity Issues ===
Core container: docker-core-1
Solr container: docker-solr-1

1. Checking current Solr configuration in core:
cat: /usr/local/tomcat/nemakiware/nemakiware.properties: No such file or directory

2. Testing Solr connectivity from core container:
✓ Core can connect to Solr

3. Checking repository ID mismatch:
Total documents: 30
Repository bedroom: 24 documents
Repository canopy: 6 documents

4. Updating repository IDs to 'bedroom':
Traceback (most recent call last):
  File "<string>", line 2, in <module>
ModuleNotFoundError: No module named 'requests'

5. Verifying fix:
Documents in bedroom repository: 24

2. Testing individual CMIS queries:
=== Testing Individual CMIS Queries ===
1. Testing basic folder query:

2. Testing root folder by ID query:

3. Testing document query:

4. Testing simple name query:

3. Checking enhanced query debug logs:
	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:207)
	at com.sun.proxy.$Proxy49.query(Unknown Source)
	at jp.aegif.nemaki.cmis.factory.CmisService.query(CmisService.java:798)
	at org.apache.chemistry.opencmis.server.support.wrapper.ConformanceCmisServiceWrapper.query(ConformanceCmisServiceWrapper.java:1218)
	at org.apache.chemistry.opencmis.server.impl.atompub.DiscoveryService$Query.serve(DiscoveryService.java:128)
	at org.apache.chemistry.opencmis.server.shared.Dispatcher.dispatch(Dispatcher.java:92)
	at org.apache.chemistry.opencmis.server.impl.atompub.CmisAtomPubServlet.dispatch(CmisAtomPubServlet.java:295)
	at org.apache.chemistry.opencmis.server.impl.atompub.CmisAtomPubServlet.service(CmisAtomPubServlet.java:206)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:623)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:199)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:168)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:130)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)
	at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:656)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:346)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:935)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1826)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.lang.Thread.run(Thread.java:750)
Caused by: java.net.ConnectException: Connection refused (Connection refused)
	at java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
	at java.net.Socket.connect(Socket.java:607)
	at org.apache.http.conn.scheme.PlainSocketFactory.connectSocket(PlainSocketFactory.java:117)
	at org.apache.http.impl.conn.DefaultClientConnectionOperator.openConnection(DefaultClientConnectionOperator.java:178)
	at org.apache.http.impl.conn.AbstractPoolEntry.open(AbstractPoolEntry.java:144)
	at org.apache.http.impl.conn.AbstractPooledConnAdapter.open(AbstractPooledConnAdapter.java:131)
	at org.apache.http.impl.client.DefaultRequestDirector.tryConnect(DefaultRequestDirector.java:610)
	at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:445)
	at org.apache.http.impl.client.AbstractHttpClient.doExecute(AbstractHttpClient.java:863)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:82)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:106)
	at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:57)
	at org.apache.solr.client.solrj.impl.HttpSolrServer.request(HttpSolrServer.java:352)
	... 69 more
No enhanced debug logs found

4. Verifying Solr index population:
Documents in bedroom repository: 24
✓ Solr index is properly populated for bedroom repository

5. Testing root folder query specifically:
  File "<string>", line 1
    import urllib.parse; print(urllib.parse.quote('SELECT cmis:name, cmis:objectId FROM cmis:folder WHERE cmis:objectId = 'e02f784f8360a02cc14d1314c10038ff''))
                                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
SyntaxError: invalid syntax. Perhaps you forgot a comma?
✗ Root folder query returned no results
Response preview:
<html><head><title>Apache Chemistry OpenCMIS - invalidArgument error</title><style><!--H1 {font-size:24px;line-height:normal;font-weight:bold;background-color:#f0f0f0;color:#003366;border-bottom:1px solid #3c78b5;padding:2px;} BODY {font-family:Verdana,arial,sans-serif;color:black;font-size:14px;} HR {color:#3c78b5;height:1px;}--></style></head><body><h1>HTTP Status 400 - <!--exception-->invalidArgument<!--/exception--></h1><p><!--message-->Statement must be set!<!--/message--></p></body></html>

6. Ready for comprehensive TCK execution
Executing comprehensive TCK tests (using standard OpenCMIS test groups)...
Using direct Maven surefire execution (bypassing Jetty completely)...
Running comprehensive TCK tests via direct surefire plugin...
Generating comprehensive TCK reports...
==========================================
NemakiWare TCK Report Generation
==========================================
Parsing TCK test results...
./generate-tck-report.sh: line 30: [: 0
0: integer expression expected

==========================================
TCK TEST RESULTS SUMMARY
==========================================
Total Tests:    0
0
Passed:         0
0
Failed:         0
0
Skipped:        0
0
Pass Rate:      0%
==========================================

Reports generated:
  - Text Report:    /home/ubuntu/repos/NemakiWare/docker/tck-reports/tck-report.txt
  - XML Report:     /home/ubuntu/repos/NemakiWare/docker/tck-reports/tck-report.xml
  - HTML Summary:   /home/ubuntu/repos/NemakiWare/docker/tck-reports/tck-summary.html

Quality Management Score: 0%

TCK report generation completed!
Generating enhanced summary with user's reporting script...
==========================================
NemakiWare CMIS TCK Test Report Summary
==========================================
Report Date:  Mon Jun 16 07:41:31 UTC 2025

Configuration:
  org.apache.chemistry.opencmis.binding.atompub.url = http://localhost:8080/core/atom/bedroom
  org.apache.chemistry.opencmis.binding.spi.type = atompub
  org.apache.chemistry.opencmis.password = admin
  org.apache.chemistry.opencmis.session.repository.id = bedroom
  org.apache.chemistry.opencmis.user = admin

Test Results:
  Total Tests: 208
  Passed:      70 (33%)
  Failed:      132 (63%)
  Warnings:    6 (2%)

Test Groups:
  - Basics Test Group (ATOMPUB)
  - ---------------------------------------------------------------
  - Control Test Group (ATOMPUB)
  - ---------------------------------------------------------------
  - Filing Test Group (ATOMPUB)
  - ---------------------------------------------------------------
  - Query Test Group (ATOMPUB)
  - ---------------------------------------------------------------
  - Types Test Group (ATOMPUB)
  - ---------------------------------------------------------------
  - Versioning Test Group (ATOMPUB)
  - ---------------------------------------------------------------

Top Failure Categories:
  10× This query is invalid and an unexcepted exception
  4× Folder query should return exactly one hit, but returned 0.
  4× Document query should return exactly one hit, but returned 0.
  2× The query should return the root folder but does not!
  2× The query should return exactly one result but returned 0!

Detailed reports available in:
  Text: /home/ubuntu/repos/NemakiWare/docker/tck-reports/tck-report.txt
  XML:  /home/ubuntu/repos/NemakiWare/docker/tck-reports/tck-report.xml

Sample Failed Tests:
INFO: Query: SELECT cmis:name AS folderName, cmis:objectId AS folderId FROM cmis:folder WHERE cmis:objectId = 'e02f784f8360a02cc14d1314c10038ff' (QueryRootFolderTest.java:78)

FAILURE: The query should return exactly one result but returned 0! (QueryRootFolderTest.java:96)
INFO: expected: 1 / actual: 0

FAILURE: The query returned a total number of items != 1, but there can be only exactly one hit! (QueryRootFolderTest.java:101)
INFO: expected: 1 / actual: 0
INFO: Query: SELECT cmis:name AS folderName, cmis:objectId AS folderId FROM cmis:folder WHERE cmis:creationDate > TIMESTAMP '2012-12-31T23:00:00.000Z' AND cmis:creationDate < TIMESTAMP '2013-01-01T01:00:00.000Z' (QueryRootFolderTest.java:129)

FAILURE: The query should return the root folder but does not! (QueryRootFolderTest.java:148)
INFO: False!

FAILURE: The query returned a total number of items < 1, but there must be at least one hit! (QueryRootFolderTest.java:153)
INFO: False!

==========================================
Validating TCK improvements and generating final reports...
=== Validating TCK Test Improvements ===
1. Analyzing current TCK results:
Could not parse test results from execution log

2. Checking for query-specific improvements:
Query-related test entries found: 0
⚠ Root folder query tests not found in logs

3. Generating final summary report:
Summary report generated: /home/ubuntu/repos/NemakiWare/docker/tck-reports/improvement-summary.txt
✓ TCK test execution completed successfully!
Reports available in: /home/ubuntu/repos/NemakiWare/docker/tck-reports/
total 180
drwxr-xr-x 2 ubuntu ubuntu  4096 Jun 16 15:08 .
drwxr-xr-x 8 ubuntu ubuntu  4096 Jun 16 14:47 ..
-rw-r--r-- 1 ubuntu ubuntu     2 Jun 16 15:08 current-score.txt
-rw-r--r-- 1 ubuntu ubuntu   468 Jun 16 15:08 improvement-summary.txt
-rw-r--r-- 1 ubuntu ubuntu    99 Jun 16 15:08 score-history.txt
-rw-r--r-- 1 ubuntu ubuntu 11445 Jun 16 15:08 tck-execution-current.log
-rw-r--r-- 1 ubuntu ubuntu 17504 Jun 16 14:55 tck-execution-fixed.log
-rw-r--r-- 1 ubuntu ubuntu 17509 Jun 16 14:59 tck-execution-gateway.log
-rw-r--r-- 1 ubuntu ubuntu 17499 Jun 16 15:03 tck-execution-host.log
-rw-r--r-- 1 ubuntu ubuntu   901 Jun 16 15:08 tck-execution.log
-rw-r--r-- 1 ubuntu ubuntu 40905 Jun 16 14:19 tck-report.txt
-rw-r--r-- 1 ubuntu ubuntu 38828 Jun 16 14:19 tck-report.xml
-rw-r--r-- 1 ubuntu ubuntu  2732 Jun 16 15:08 tck-summary.html
Current TCK Score: 0%

=== IMPROVEMENT SUMMARY ===
=== NemakiWare TCK Test Improvement Summary ===
Date: Mon Jun 16 15:08:42 UTC 2025
Target: >75% pass rate
Previous: 70.12% (108/154 tests)

Current Results:
- Total Tests: N/A
- Passed: N/A
- Pass Rate: N/A%

Key Improvements Applied:
1. Enhanced CMIS query debug logging
2. Fixed Solr connectivity issues
3. Resolved repository ID mismatches
4. Improved property mapping error handling
5. Added comprehensive query translation logging

Status: NEEDS FURTHER WORK ⚠
