# =============================================================================
# NemakiWare + OpenLDAP Test Environment
# =============================================================================
#
# Domain: dc=nemakiware,dc=example,dc=com
# Admin DN: cn=admin,dc=nemakiware,dc=example,dc=com
# Admin Password: adminpassword
#
# Usage:
#   docker compose -f docker-compose-ldap.yml up -d
#
# =============================================================================

services:
  # CouchDB 3.x - Current version
  couchdb:
    image: couchdb:3.3.3
    ports:
      - "5984:5984"
    volumes:
      - couchdb_data:/opt/couchdb/data
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-password}
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "${COUCHDB_USER:-admin}:${COUCHDB_PASSWORD:-password}", "http://localhost:5984/_all_dbs"]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 30s

  # Solr Search Engine
  solr:
    build: ./solr
    ports:
      - "8983:8983"
    environment:
      - SOLR_HOME=/var/solr/data
      - SOLR_HEAP=512m
    volumes:
      - solr_data:/var/solr/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/admin/cores?action=STATUS"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Core CMIS Server
  core:
    build:
      context: ./core
      dockerfile: Dockerfile.simple
    ports:
      - "8080:8080"
    depends_on:
      couchdb:
        condition: service_healthy
      solr:
        condition: service_healthy
      openldap:
        condition: service_healthy
    environment:
      - JAVA_OPTS=-Dorg.ektorp.support.AutoUpdateViewOnChange=false -Dorg.ektorp.http.IdleConnectionMonitor.enabled=false -Dorg.ektorp.support.DesignDocument.UPDATE_ON_DIFF=false -Dorg.ektorp.support.DesignDocument.ALLOW_AUTO_UPDATE=true -Dorg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_REFERENCES=true -Dorg.apache.tomcat.util.scan.StandardJarScanFilter.jarsToSkip=*.jar
      - "CATALINA_OPTS=-Xms1g -Xmx3g -XX:+DisableExplicitGC -Dnemakiware.properties=/usr/local/tomcat/conf/nemakiware.properties -Drepositories.yml=/usr/local/tomcat/conf/repositories.yml -Dlog4j.configuration=file:/usr/local/tomcat/conf/log4j.properties -Ddb.couchdb.auth.enabled=true -Ddb.couchdb.auth.username=${COUCHDB_USER:-admin} -Ddb.couchdb.auth.password=${COUCHDB_PASSWORD:-password} -Dsolr.host=solr -Dsolr.port=8983 -Dsolr.protocol=http -Ddirectory.sync.enabled=true -Ddirectory.sync.ldap.url=ldap://openldap:389 -Ddirectory.sync.ldap.base.dn=dc=nemakiware,dc=example,dc=com -Ddirectory.sync.ldap.bind.dn=cn=admin,dc=nemakiware,dc=example,dc=com -Ddirectory.sync.ldap.bind.password=adminpassword -Ddirectory.sync.group.search.base=ou=groups '-Ddirectory.sync.group.search.filter=(objectClass=groupOfNames)' -Ddirectory.sync.user.search.base=ou=users '-Ddirectory.sync.user.search.filter=(objectClass=inetOrgPerson)' -Ddirectory.sync.group.id.attribute=cn -Ddirectory.sync.group.name.attribute=cn -Ddirectory.sync.group.member.attribute=member -Ddirectory.sync.user.id.attribute=uid -Ddirectory.sync.group.prefix=ldap_ -Ddirectory.sync.user.prefix= -Ddirectory.sync.create.missing.users=true -Ddirectory.sync.update.existing.users=true"
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/core"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # OpenLDAP Server for Directory Sync Testing
  openldap:
    image: osixia/openldap:1.5.0
    container_name: openldap
    ports:
      - "389:389"
      - "636:636"
    environment:
      - LDAP_ORGANISATION=NemakiWare Test
      - LDAP_DOMAIN=nemakiware.example.com
      - LDAP_BASE_DN=dc=nemakiware,dc=example,dc=com
      - LDAP_ADMIN_PASSWORD=adminpassword
      - LDAP_CONFIG_PASSWORD=configpassword
      - LDAP_READONLY_USER=false
      - LDAP_TLS=false
      - LDAP_SEED_INTERNAL_LDIF_PATH=/ldif-seed
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./ldap/bootstrap:/ldif-seed:ro
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost:389", "-b", "dc=nemakiware,dc=example,dc=com", "-D", "cn=admin,dc=nemakiware,dc=example,dc=com", "-w", "adminpassword"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # phpLDAPadmin - Web-based LDAP management
  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    ports:
      - "8443:443"
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=openldap
      - PHPLDAPADMIN_HTTPS=true
    depends_on:
      - openldap

volumes:
  couchdb_data:
  solr_data:
  ldap_data:
  ldap_config:

networks:
  default:
    name: nemaki-ldap-network
