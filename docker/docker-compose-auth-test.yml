# Docker Compose for OIDC/SAML Authentication Testing
# Uses Keycloak as a local Identity Provider (IdP)
#
# Usage:
#   docker compose -f docker-compose-auth-test.yml up -d
#
# Keycloak Admin Console: http://localhost:8180/admin
#   Username: admin
#   Password: admin
#
# Pre-configured Test Users:
#   - testuser / testpass (OIDC and SAML)
#   - admin / admin (NemakiWare admin, also in Keycloak)
#
# OIDC Configuration:
#   Authority: http://localhost:8180/realms/nemakiware
#   Client ID: nemakiware-ui
#   Client Secret: nemakiware-secret
#
# SAML Configuration:
#   IdP Entity ID: http://localhost:8180/realms/nemakiware
#   IdP SSO URL: http://localhost:8180/realms/nemakiware/protocol/saml
#   SP Entity ID: nemakiware-sp

services:
  # CouchDB 3.x - Document Database
  couchdb:
    image: couchdb:3.3.3
    ports:
      - "5984:5984"
    volumes:
      - couchdb_auth_data:/opt/couchdb/data
    environment:
      - COUCHDB_USER=${COUCHDB_USER:-admin}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-password}
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "${COUCHDB_USER:-admin}:${COUCHDB_PASSWORD:-password}", "http://localhost:5984/_all_dbs"]
      interval: 5s
      timeout: 10s
      retries: 20
      start_period: 30s

  # Solr Search Engine
  solr:
    build: ./solr
    ports:
      - "8983:8983"
    environment:
      - SOLR_HOME=/var/solr/data
      - SOLR_HEAP=512m
    volumes:
      - solr_auth_data:/var/solr/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/admin/cores?action=STATUS"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Core CMIS Server
  core:
    build:
      context: ./core
      dockerfile: Dockerfile.simple
    ports:
      - "8080:8080"
    depends_on:
      couchdb:
        condition: service_healthy
      solr:
        condition: service_healthy
    environment:
      - JAVA_OPTS=-Dorg.ektorp.support.AutoUpdateViewOnChange=false -Dorg.ektorp.http.IdleConnectionMonitor.enabled=false -Dorg.ektorp.support.DesignDocument.UPDATE_ON_DIFF=false -Dorg.ektorp.support.DesignDocument.ALLOW_AUTO_UPDATE=true -Dorg.apache.catalina.loader.WebappClassLoader.ENABLE_CLEAR_REFERENCES=true -Dorg.apache.tomcat.util.scan.StandardJarScanFilter.jarsToSkip=*.jar
      - CATALINA_OPTS=-Xms1g -Xmx3g -XX:+DisableExplicitGC -Dnemakiware.properties=/usr/local/tomcat/conf/nemakiware.properties -Drepositories.yml=/usr/local/tomcat/conf/repositories.yml -Dlog4j.configuration=file:/usr/local/tomcat/conf/log4j.properties -Ddb.couchdb.auth.enabled=true -Ddb.couchdb.auth.username=${COUCHDB_USER:-admin} -Ddb.couchdb.auth.password=${COUCHDB_PASSWORD:-password} -Dsolr.host=solr -Dsolr.port=8983 -Dsolr.protocol=http
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/core"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Keycloak Identity Provider for OIDC/SAML Testing
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    ports:
      - "8180:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    command:
      - start-dev
      - --import-realm
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

volumes:
  couchdb_auth_data:
  solr_auth_data:

networks:
  default:
    name: nemaki-auth-network
