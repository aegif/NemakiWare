# Rendition Design Review Feedback (Follow-up)

このドキュメントは、提示された「NemakiWare 3.0 RC Rendition」詳細設計に対する再レビューコメントを整理したものです。要求された修正が反映されたかを確認するための着眼点として利用してください。

## 要件適合性に関する懸念
- **CMIS rendition kind のデフォルト表記**: 要件は `preview` をデフォルトとする前提。設計中の `cmis:preview` 固定ロジックや UI の依存箇所が残っていないかを要確認。
- **旧 2.4 DB との透過互換**: `renditionIds` 未保持ドキュメントのプレビュー要求時に例外フックや遅延生成が適切か、バックエンドの明示的フローが不足していないかを再点検。
- **外部コマンド／サービス連携**: プロパティは追加されているが、JOD 固定実装のままなら要件の「パス・認証情報を設定で制御」が未達。抽象化インターフェースやエラー処理方針の追記が必要。
- **形式マッピングの整合**: `rendition-mapping.yml` と `checkConvertible()` の整合性、複数出力（例: サムネイル＋PDF）の扱い、複数コンバータ拡張の余地が設計上明文化されているか確認。
- **カスケード削除の保証**: 追加ビューや遅延生成と削除処理の整合、外部コンバータで生成された添付の一括削除が担保されているかを再確認。

## 設計上のリスク
- **認可の欠落**: REST API で `SystemCallContext` を直接利用する場合、権限チェックをバイパスするリスク。少なくとも Read/Write 権限検証や管理者限定制御を入れる必要がある。
- **エラーハンドリングの可観測性不足**: `convertToPdf()` 失敗を `null` 戻りで握りつぶすだけでは原因追跡が困難。失敗イベントの計測・ログ粒度・リトライ方針を追加すべき。
- **遅延生成の負荷**: `getRenditions()` で同期的に LibreOffice/JOD を起動すると UI レイテンシーやスレッド枯渇を招く恐れ。非同期キュー化や最大同時実行数の制御を検討。
- **マッピング適用の不統一**: `createPreview()` は kind をマッピングから取得する一方、`convertToPdf()` は出力 MIME を固定。マッピングに複数ターゲットを指定しても反映されない設計になっていないか。
- **レンディション配信 URL の整合**: `cmisselector`/`streamId`/`renditionFilter` の組み合わせがサーバ側ハンドラと一致しているか再確認。ブラウザバインディングの仕様整合が不明確。
- **デフォルト値の一元管理不足**: プロパティのデフォルトが各所に散在していないか。`PropertyKey` か設定ローダで集中管理する方針が必要。
- **移行手順の曖昧さ**: 2.4 DB へのビュー追加だけでなく、初回起動時のビュー再生成・キャッシュ無効化、パフォーマンス影響やダウンタイム見積りが説明されているか要確認。

## UI 側の懸念
- **エラー時の UX**: `getRenditions()` 失敗時に空配列を返すだけだと認可エラーや 500 を検知できない。通知・再試行・管理者向けモニタリングへの連携が必要。
- **プレビュー分岐の固定化**: Office→PDF のみを想定している場合、画像サムネイルや他フォーマットのレンディションを柔軟に扱えない。MIME 判定の拡張性を確保するべき。
- **Base URL の整合性**: 既存 `cmis.ts` の base URL と新設 `renditionBaseUrl` が混在する場合、リバースプロキシ設定により 404 リスクあり。統一方針を明文化すること。

## 運用・セキュリティ・テスト
- **バッチ API の負荷制御**: `force=true` 連打で LibreOffice プロセスがスパイクするリスク。レートリミットやキュー制御の設計を補うべき。
- **テスト戦略の具体性不足**: LibreOffice 非導入環境でのスキップ条件やモック方針を含む CI 戦略を明記。失敗時の診断ログ取得方法も整理する。
- **監視と計測**: レンディション生成の成功/失敗・処理時間・キュー長など、運用監視に必要なメトリクス/ログ項目を定義すること。

## 推奨される次アクション
- 認可チェックの追加（特に REST/Bulk API）。
- レンディション生成の非同期キュー化と最大同時実行数の制限。
- マッピング適用の統一（ターゲット MIME／コンバータ選択を抽象化）。
- プロパティデフォルトの集中管理とフェイルセーフの明文化。
- 旧 DB 移行手順の詳細化（ビュー再生成、ダウンタイム見積り、再インデックス手順）。
- UI のエラー通知と Base URL 方針の統一化。

---


## 追加フォローアップ（Design v2.1 対応状況の速記レビュー）
- **認可/認証**: `/api/*` へのフィルタ追加と権限チェック方針が追記されている点は改善。ただし「管理者判定の取得箇所」「CallContext をどのフィルタで格納するか」を明示的に記載しないと実装者が迷う。
- **lazy 生成オプション**: Option A/B/C が列挙され、デフォルト無効であることが明確化されたのは良いが、「運用で許可する判断基準（リポジトリ件数・ドキュメントサイズ上限等）」を簡潔に示すとさらに安全。
- **デフォルト値集中管理**: `init()` でのデフォルト集中は改善だが、PropertyKey 側にドキュメントコメントを加え、設定が無い場合のフォールバックを一目で把握できるようにすると移行時の事故を減らせる。
- **マッピングと実装の乖離説明**: PDF 固定で `targetMediaType` が無視される旨が明示されたが、将来拡張の際に「どの層を差し替えると複数出力に対応できるか（コンバータ抽象の追加ポイント）」を短く書くとレビュー/実装計画が立てやすい。
- **移行・初回起動の手順**: インデックス再構築の注意点とウォームアップ curl が明記されたのは良い。追加で「運用が確認すべき CouchDB ログの具体的パターン」や「想定所要時間の目安（件数×概算）」があると実務で助かる。
- **UI 側エラーハンドリング**: ログ戦略が追加されたが、UI での明示的なエラー表示/リトライ方針は依然不足。最小限でも「管理者向けにトースト表示し、再試行ボタンを出す」などの案を追記しておきたい。

## さらなるフォローアップ（Design v2.2 反映確認）
- **CallContext の格納と admin 判定の明記**: `AuthenticationFilter.login()` で `request.setAttribute("CallContext", ctxt)` を行い、`CallContextKey.IS_ADMIN` で管理者判定している旨が文書化された点は前進。実装ではこの前提が外れないか（フィルタ順序や例外時の null ハンドリング）を再確認すること。
- **lazy 生成の運用基準**: リポジトリ規模・ファイルサイズ・同時ユーザ数を基準に Option A を有効化するか判断する目安が追加された。合わせて、設定変更時に周知すべき運用手順（ピーク時間帯の回避、LibreOffice プロセス監視）も短く触れるとさらに実務的。
- **PropertyKey の Javadoc 追加**: デフォルト値をコメントで明示した点は評価。設定ファイルとの差分を一目で確認できるよう、今後の PR で `nemakiware.properties` にも同一コメントを並べると移行時の混乱を減らせる。
- **複数出力対応の拡張ポイント**: `RenditionManager` への多重出力拡張案が示され、拡張箇所が明確になったのは良い。後方互換を壊さないよう、現行メソッドのシグネチャ維持と新メソッド追加の方針を明記しておくとさらに安心。
- **CouchDB ログパターンと時間見積り**: ログ例と概算式が追記されたため、運用側の観点は大幅に改善。ただし本番ハードウェアでの既知計測値があれば例示すると、より信頼できる目安になる。
- **UI エラー表示と再試行**: Ant Design `message.error` と再試行ボタンの提示が具体化された。最小実装として「一定回数失敗でダウンロード提示にフォールバック」などの UX シナリオを追加で触れておくと、実装者が迷わない。
