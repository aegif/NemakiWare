name: NemakiWare UI Tests with Playwright

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'core/src/main/webapp/ui/**'
      - 'core/src/main/java/**'
      - 'core/pom.xml'
      - '.github/workflows/ui-tests.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'core/src/main/webapp/ui/**'
      - 'core/src/main/java/**'
      - 'core/pom.xml'
      - '.github/workflows/ui-tests.yml'

jobs:
  ui-tests:
    name: UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      couchdb:
        image: couchdb:3.3
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: password
        ports:
          - 5984:5984
        options: >-
          --health-cmd "curl -f http://admin:password@localhost:5984/_up"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5

      solr:
        image: solr:9
        env:
          SOLR_HEAP: 512m
        ports:
          - 8983:8983
        options: >-
          --health-cmd "curl -f http://localhost:8983/solr/admin/info/system"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Set up Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'core/src/main/webapp/ui/package-lock.json'

    - name: Wait for services to be ready
      run: |
        # Wait for CouchDB
        echo "Waiting for CouchDB..."
        for i in {1..30}; do
          if curl -f http://admin:password@localhost:5984/_up; then
            echo "CouchDB is ready"
            break
          fi
          echo "Waiting for CouchDB... ($i/30)"
          sleep 10
        done

        # Wait for Solr
        echo "Waiting for Solr..."
        for i in {1..30}; do
          if curl -f http://localhost:8983/solr/admin/info/system; then
            echo "Solr is ready"
            break
          fi
          echo "Waiting for Solr... ($i/30)"
          sleep 10
        done

    - name: Build NemakiWare Dependencies
      run: |
        # Build parent POM first
        echo "Installing parent POM..."
        mvn clean install -N -DskipTests -q
        
        # Build dependency modules
        echo "Building common module..."
        mvn clean install -f common/pom.xml -DskipTests -q
        
        echo "Building cloudant-init module..."
        mvn clean install -f cloudant-init/pom.xml -DskipTests -q
        
        echo "Building solr module..."
        mvn clean install -f solr/pom.xml -DskipTests -q

    - name: Build NemakiWare Core
      run: |
        # Build the core WAR file with all dependencies
        mvn clean package -f core/pom.xml -Pdevelopment -DskipTests -q

        # Verify WAR file was created
        ls -la core/target/core.war

    - name: Start NemakiWare Server
      run: |
        # Copy WAR to a location where we can serve it
        mkdir -p test-server
        cp core/target/core.war test-server/

        # Start embedded Tomcat server in background
        cd test-server
        java -jar ../core/target/core.war --server.port=8080 &

        # Store the PID for later cleanup
        echo $! > server.pid

        # Wait for server to start
        echo "Waiting for NemakiWare server to start..."
        for i in {1..60}; do
          if curl -f http://localhost:8080/core/ui/dist/; then
            echo "NemakiWare server is ready"
            break
          fi
          echo "Waiting for server... ($i/60)"
          sleep 5
        done

    - name: Install UI dependencies
      working-directory: core/src/main/webapp/ui
      run: |
        npm ci
        npx playwright install --with-deps

    - name: Run Playwright tests
      working-directory: core/src/main/webapp/ui
      run: |
        # Set base URL for tests
        export PLAYWRIGHT_BASE_URL=http://localhost:8080

        # Run all tests
        npx playwright test --reporter=github

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: core/src/main/webapp/ui/playwright-report/
        retention-days: 30

    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-screenshots
        path: core/src/main/webapp/ui/test-results/
        retention-days: 30

    - name: Cleanup
      if: always()
      run: |
        # Stop the server if it's running
        if [ -f test-server/server.pid ]; then
          kill $(cat test-server/server.pid) || true
        fi

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: ui-tests
    if: always()

    steps:
    - name: Report Test Results
      run: |
        if [ "${{ needs.ui-tests.result }}" == "success" ]; then
          echo "‚úÖ All UI tests passed successfully!"
          echo "üéâ NemakiWare React UI is working correctly"
        else
          echo "‚ùå Some UI tests failed"
          echo "üìã Check the test results and screenshots in the artifacts"
          exit 1
        fi
