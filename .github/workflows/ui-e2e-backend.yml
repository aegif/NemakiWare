name: UI E2E (with Backend)

on:
  pull_request:
  workflow_dispatch:

jobs:
  e2e-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install OpenCMIS 1.2.0-SNAPSHOT jars and parent POM into local maven
        run: |
          set -e
          JARS_DIR="build-workspace/chemistry-opencmis/built-jars"
          declare -a ARTIFACTS=(
            "chemistry-opencmis-commons-api"
            "chemistry-opencmis-commons-impl"
            "chemistry-opencmis-server-support"
            "chemistry-opencmis-server-bindings"
            "chemistry-opencmis-client-impl"
            "chemistry-opencmis-client-api"
            "chemistry-opencmis-client-bindings"
            "chemistry-opencmis-test-tck"
          )
          for A in "${ARTIFACTS[@]}"; do
            FILE="$JARS_DIR/$A-1.2.0-SNAPSHOT.jar"
            if [ -f "$FILE" ]; then
              mvn -q install:install-file -Dfile="$FILE" -DgroupId=org.apache.chemistry.opencmis -DartifactId="$A" -Dversion=1.2.0-SNAPSHOT -Dpackaging=jar
            else
              echo "WARNING: Missing $FILE"
            fi
          done
          # Install the parent POM so Maven can resolve artifact descriptors
          POM_FILE="$JARS_DIR/chemistry-opencmis-1.2.0-SNAPSHOT.pom"
          if [ -f "$POM_FILE" ]; then
            mvn -q install:install-file -Dfile="$POM_FILE" -DgroupId=org.apache.chemistry.opencmis -DartifactId=chemistry-opencmis -Dversion=1.2.0-SNAPSHOT -Dpackaging=pom
          else
            echo "Parent POM not found at $POM_FILE, generating a minimal POM for installation"
            TMP_POM="$(mktemp)"
            cat > "$TMP_POM" <<'EOF'
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>org.apache.chemistry.opencmis</groupId>
  <artifactId>chemistry-opencmis</artifactId>
  <version>1.2.0-SNAPSHOT</version>
  <packaging>pom</packaging>
  <name>chemistry-opencmis parent (local)</name>
</project>
EOF
            mvn -q install:install-file -Dfile="$TMP_POM" -DgroupId=org.apache.chemistry.opencmis -DartifactId=chemistry-opencmis -Dversion=1.2.0-SNAPSHOT -Dpackaging=pom
          fi

      - name: Install nemakiware-action plugin (local maven)
        working-directory: suspended-modules/action
        run: mvn -q -DskipTests install

      - name: Build NemakiWare modules (install to local maven)
        run: mvn -q -DskipTests install

      - name: Start CouchDB
        run: |
          docker run -d --name couchdb-dev -p 5984:5984 \
            -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password couchdb:3
          for i in {1..30}; do
            if curl -sf http://localhost:5984/ >/dev/null; then
              echo "CouchDB ready"; exit 0
            fi
            sleep 2
          done
          echo "CouchDB did not become ready" && exit 1

      - name: Start Jetty (Core)
        working-directory: core
        env:
          MAVEN_OPTS: "--add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.text=ALL-UNNAMED --add-opens=java.desktop/java.awt.font=ALL-UNNAMED"
        run: |
          nohup mvn -q -DskipTests jetty:run -Pdevelopment -Djetty.port=8080 > ../jetty.log 2>&1 &

      - name: Check backend readiness (Jetty)
        id: check_jetty
        run: |
          READY=false
          for i in {1..120}; do
            if curl -sf http://localhost:8080/core/rest/all/repositories >/dev/null; then
              echo "Backend ready"
              READY=true
              break
            fi
            sleep 5
          done
          if [ "$READY" != "true" ]; then
            echo "Backend did not become ready from Jetty source run"
            echo "==== Last 400 lines of jetty.log ===="
            tail -n 400 jetty.log || true
            echo "BACKEND_READY=false" >> "$GITHUB_ENV"
          else
            echo "BACKEND_READY=true" >> "$GITHUB_ENV"
          fi

      - name: Start containerized backend fallback
        if: env.BACKEND_READY != 'true'
        run: |
          docker compose -f docker/docker-compose-containerized.yml up -d couchdb core
          for i in {1..120}; do
            if curl -sf http://localhost:8080/core/rest/all/repositories >/dev/null; then
              echo "Containerized backend ready"
              exit 0
            fi
            sleep 5
          done
          echo "Containerized backend did not become ready"
          docker compose -f docker/docker-compose-containerized.yml logs --tail=200 core || true
          exit 1

      - name: Install UI deps
        working-directory: core/src/main/webapp/ui
        run: npm ci || npm install

      - name: Install Playwright browsers
        working-directory: core/src/main/webapp/ui
        run: npx playwright install --with-deps

      - name: Run Playwright (backend)
        working-directory: core/src/main/webapp/ui
        env:
          VITE_PROXY_TARGET: "http://localhost:8080"
          E2E_WITH_BACKEND: "true"
        run: npm run test:e2e
