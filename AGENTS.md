# NemakiWare ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€£æºã‚¬ã‚¤ãƒ‰

**æœ€çµ‚æ›´æ–°**: 2025-11-01
**å¯¾è±¡**: Claude Codeã€Devinã€Cursorã€ãã®ä»–ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
**ç›®çš„**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§ã‚¹ãƒ ãƒ¼ã‚ºã«ã‚¿ã‚¹ã‚¯ã‚’å§”è­²ã§ãã‚‹ä½“åˆ¶ã‚’æ§‹ç¯‰

---

## ğŸ“Œ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„

CLAUDE.mdã¯Claude Codeå›ºæœ‰ã®æŠ€è¡“è©³ç´°ã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™ãŒã€ã“ã®AGENTS.mdã¯**å…¨ã¦ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ãŒå‚ç…§ã§ãã‚‹æ±ç”¨çš„ãªã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ç‰¹ã«**ãƒ†ã‚¹ãƒˆã®å§”è­²**ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ¤ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã®æ¨å¥¨ã‚¿ã‚¹ã‚¯

### Claude Code
**å¾—æ„åˆ†é‡**: Javaãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€CMISä»•æ§˜ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- CMISã‚µãƒ¼ãƒ“ã‚¹å±¤ã®å®Ÿè£…ãƒ»ä¿®æ­£
- TCKæº–æ‹ ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ãƒ»ãƒ‡ãƒãƒƒã‚°
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ã®æœ€é©åŒ–
- æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™

### Devin
**å¾—æ„åˆ†é‡**: UIãƒ†ã‚¹ãƒˆã€E2Eãƒ†ã‚¹ãƒˆã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã€ä¸¦åˆ—ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- **Playwrightãƒ†ã‚¹ãƒˆã®ä½œæˆãƒ»ä¿®æ­£**ï¼ˆæœ€é©ï¼‰
- React UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- UI/UXã®æ”¹å–„
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š

**Devinã¸ã®å§”è­²ä¾‹**:
```markdown
ã‚¿ã‚¹ã‚¯: Playwrightã‚¹ã‚­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆã®è§£é™¤
ç¯„å›²: tests/admin/custom-type-creation.spec.ts
å‰ææ¡ä»¶: ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ä½œæˆUIãŒå®Ÿè£…æ¸ˆã¿
æœŸå¾…æˆæœ: test.describe.skip â†’ test.describe ã«å¤‰æ›´ã—ã€å…¨ãƒ†ã‚¹ãƒˆé€šé
```

### Cursor
**å¾—æ„åˆ†é‡**: ã‚³ãƒ¼ãƒ‰ç·¨é›†ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¿®æ­£
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- ãƒã‚°ä¿®æ­£
- TypeScriptå‹å®šç¾©ã®æ”¹å–„
- å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ

### ãã®ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
**æ±ç”¨çš„ãªã‚¿ã‚¹ã‚¯**:
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£
- QAãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆå§”è­²ã®ãƒ—ãƒ­ã‚»ã‚¹

### ã‚¹ãƒ†ãƒƒãƒ—1: å§”è­²å‰ã®æº–å‚™ï¼ˆå§”è­²å…ƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. ç’°å¢ƒã®å¥å…¨æ€§ç¢ºèª
docker ps                       # å…¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª
./qa-test.sh                    # QAãƒ†ã‚¹ãƒˆå…¨é€šéç¢ºèªï¼ˆ56/56ï¼‰
git status                      # ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ç¢ºèª

# 2. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³çµæœã®è¨˜éŒ²
cd core/src/main/webapp/ui
npx playwright test > baseline_results.txt
# ç¾åœ¨ã®é€šéç‡ã‚’è¨˜éŒ²

# 3. å§”è­²å†…å®¹ã‚’HANDOFF.mdã«è¨˜è¼‰
```

**å§”è­²å†…å®¹ã®æ˜ç¢ºåŒ–**:
- [ ] ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã‹ï¼ˆä¾‹: ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ä½œæˆæ©Ÿèƒ½ï¼‰
- [ ] ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¯¾è±¡ã‹ï¼ˆä¾‹: tests/admin/custom-type-creation.spec.tsï¼‰
- [ ] å‰ææ¡ä»¶ã¯ä½•ã‹ï¼ˆä¾‹: UIãŒå®Ÿè£…æ¸ˆã¿ã€ã‚¹ã‚­ãƒƒãƒ—ã‚’è§£é™¤ï¼‰
- [ ] æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©ï¼ˆä¾‹: ãƒ†ã‚¹ãƒˆé€šéç‡ã®å‘ä¸Šã€ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
docker ps                       # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª
curl -u admin:admin http://localhost:8080/core/atom/bedroom  # ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª
cd core/src/main/webapp/ui
npx playwright --version        # Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª

# 2. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å‰ã®çŠ¶æ…‹ç¢ºèªï¼‰
npx playwright test --project=chromium

# 3. ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆä¾‹: ã‚¹ã‚­ãƒƒãƒ—è§£é™¤ï¼‰
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦test.describe.skip â†’ test.describe

# 4. ãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
npx playwright test tests/admin/custom-type-creation.spec.ts --project=chromium

# 5. çµæœã®è¨˜éŒ²
npx playwright show-report
```

### ã‚¹ãƒ†ãƒƒãƒ—3: æˆæœç‰©ã®è¨˜éŒ²ï¼ˆå§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ
git add tests/admin/custom-type-creation.spec.ts
git commit -m "test: Enable custom type creation tests"

# 2. HANDOFF.mdã®æ›´æ–°
# - å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆ
# - é€šé/å¤±æ•—ã®è©³ç´°
# - ç™ºè¦‹ã—ãŸãƒã‚°
# - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ææ¡ˆ

# 3. ãƒ—ãƒƒã‚·ãƒ¥
git push origin <branch-name>
```

---

## âœ… ãƒ†ã‚¹ãƒˆå§”è­²ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å§”è­²å…ƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆClaude Codeç­‰ï¼‰

**ç’°å¢ƒæº–å‚™**:
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠå…¨ã¦èµ·å‹•æ¸ˆã¿ï¼ˆ`docker ps`ã§ç¢ºèªï¼‰
- [ ] QAãƒ†ã‚¹ãƒˆå…¨é€šéï¼ˆ`./qa-test.sh` â†’ 56/56ï¼‰
- [ ] Gitãƒ–ãƒ©ãƒ³ãƒãŒã‚¯ãƒªãƒ¼ãƒ³ï¼ˆ`git status`ï¼‰
- [ ] æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

**å§”è­²å†…å®¹ã®æ˜ç¢ºåŒ–**:
- [ ] HANDOFF.mdã«å§”è­²å†…å®¹ã‚’è¨˜è¼‰
- [ ] å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«/æ©Ÿèƒ½ã‚’ç‰¹å®š
- [ ] å‰ææ¡ä»¶ã‚’æ˜è¨˜ï¼ˆä¾‹: UIå®Ÿè£…æ¸ˆã¿ï¼‰
- [ ] æœŸå¾…æˆæœã‚’å®šç¾©ï¼ˆä¾‹: ãƒ†ã‚¹ãƒˆé€šéã€ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆï¼‰

### å§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆDevinã€Cursorç­‰ï¼‰

**ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**:
- [ ] Java 17ç¢ºèªï¼ˆTCKãƒ†ã‚¹ãƒˆã®å ´åˆã®ã¿ï¼‰
- [ ] Node.js 18+ç¢ºèªï¼ˆPlaywrightãƒ†ã‚¹ãƒˆã®å ´åˆï¼‰
- [ ] Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼ˆ`npx playwright install`ï¼‰
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰**:
- [ ] HANDOFF.mdã‚’èª­ã‚“ã§å§”è­²å†…å®¹ã‚’ç†è§£
- [ ] BUILD_DEPLOY_GUIDE.mdã§ãƒ“ãƒ«ãƒ‰æ‰‹é †ã‚’ç¢ºèª
- [ ] ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å‰ã®çŠ¶æ…‹ç¢ºèªï¼‰

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œ**:
- [ ] ãƒ†ã‚¹ãƒˆçµæœã®è¨˜éŒ²ï¼ˆé€šé/å¤±æ•—ã®è©³ç´°ï¼‰
- [ ] ãƒã‚°ã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯è©³ç´°ã‚’ãƒ¬ãƒãƒ¼ãƒˆ
- [ ] å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
- [ ] HANDOFF.mdã‚’æ›´æ–°ï¼ˆæ¬¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ï¼‰

---

# Repository Guidelines

## Project Structure & Modules
- `common/` â€” Shared utilities (JAR).
- `core/` â€” CMIS REST/Web Services server (WAR, Jakarta EE 10, Spring 6).
  - `core/src/main/webapp/ui/` â€” React SPA UI (Vite + TypeScript + Ant Design)
  - `core/src/main/webapp/ui/tests/` â€” Playwright E2E tests
- `solr/` â€” Search integration helpers.
- `cloudant-init/` â€” CouchDB/Cloudant bootstrap tools.
- `docker/` â€” Compose files, images, and runtime config.
- `setup/`, `war_content/`, `WEB-INF/` â€” Installer and packaging assets.
- Tests live under `*/src/test/java`; reports under `*/test-reports/`.

## Build, Test, and Run

### Backend Build
- Build all modules: `mvn -T 1C -DskipTests install` (root `pom.xml`).
- Build server only: `mvn -pl core -am package` (produces `core/target/core.war`).
- Run dev server (Jetty 11): `cd core && ./start-jetty-dev.sh`.
  - Access CMIS: `http://localhost:8080/core/atom/bedroom` (admin:admin).
- Run tests (JUnit 4): `mvn test` or `mvn -pl core test`.

### React UI Build and Deployment

**Important**: React UI must be built and deployed to WAR file for production use.

```bash
# 1. Build React UI (from UI directory)
cd core/src/main/webapp/ui
npm install  # First time only
npm run build

# 2. Build core WAR with UI assets
cd /path/to/NemakiWare
mvn clean package -f core/pom.xml -Pdevelopment -DskipTests

# 3. Copy WAR to Docker directory
cp core/target/core.war docker/core/core.war

# 4. Deploy via Docker
cd docker
docker compose -f docker-compose-simple.yml down
docker compose -f docker-compose-simple.yml up -d --build --force-recreate

# 5. Wait for startup (ç´„90ç§’)
sleep 90

# 6. Verify UI is accessible
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/core/ui/dist/index.html
# Expected: 200
```

### Docker Environment
- Full stack via Docker: `docker compose -f docker/docker-compose-simple.yml up -d`.
- Services: CouchDB (5984), Solr (8983), Tomcat Core (8080)
- Check status: `docker compose -f docker/docker-compose-simple.yml ps`
- View logs: `docker compose -f docker/docker-compose-simple.yml logs core`

### Playwright UI Tests

**Current Test Status** (2025-10-25):
- âœ… 69 tests passing (67%)
- âŒ 4 tests failing (4%)
- â­ï¸ 30 tests skipped (29%)
- Total: 103 tests

**Running Tests**:
```bash
# All tests (single browser, sequential)
cd core/src/main/webapp/ui
npx playwright test --project=chromium --workers=1

# Specific test file
npx playwright test tests/versioning/document-versioning.spec.ts --project=chromium --workers=1

# Specific test case
npx playwright test tests/versioning/document-versioning.spec.ts:37 --project=chromium --workers=1

# Debug mode (with browser UI)
npx playwright test --project=chromium --debug

# Generate HTML report
npx playwright show-report
```

**Test Environment Requirements**:
- Docker containers must be running (see Docker Environment section)
- Server must be healthy: `http://localhost:8080/core/ui/dist/index.html` returns 200
- Recommended: Single worker (`--workers=1`) to avoid race conditions

## Coding Style & Naming
- Java 17; use Jakarta APIs (`jakarta.*`), avoid `javax.*`.
- Indentation: 4 spaces, UTF-8, 120-col soft wrap.
- Packages: `jp.aegif.nemaki...`; Classes `PascalCase`, methods/fields `camelCase`, constants `UPPER_SNAKE_CASE`.
- Prefer SLF4J (`org.slf4j.Logger`) over `System.out`.
- Module boundaries: put shared code in `common/`; CMIS/server code in `core/`.
- React/TypeScript: Follow standard TypeScript/React conventions, use functional components with hooks.

## Testing Guidelines

### JUnit Tests (Backend)
- Framework: JUnit 4 (Surefire configured with Java 17 module opens).
- Place tests in `src/test/java`; name files `*Test.java`.
- Keep unit tests fast and isolated (mock Solr when applicable).
- Useful scripts: `qa-test.sh`, `test-rest-api-comprehensive.sh`.

### Playwright Tests (UI)
- Framework: Playwright (TypeScript)
- Test files: `core/src/main/webapp/ui/tests/**/*.spec.ts`
- Test helpers: `tests/utils/auth-helper.ts`, `tests/utils/test-helper.ts`
- Configuration: `playwright.config.ts`

**Key Test Helpers**:
- `AuthHelper`: Login/logout, session management
- `TestHelper`: Ant Design element waiting, common UI interactions
- `uploadDocument()`: Document upload with retry logic

**Known Issues** (as of 2025-10-25):
1. **Document Versioning Tests** (4 failing):
   - check-in: Cleanup timeout
   - cancel check-out: Cleanup timeout
   - version history: Modal selector mismatch
   - version download: Filename mismatch

2. **Skipped Tests** (30 tests):
   - UI not implemented: Custom Type Creation, Group/User Management CRUD, Permission Management
   - Partial WIP: PDF Preview
   - Test issues: Access Control (test user timeout), Document Viewer Auth

**Important Fixes Applied** (2025-10-24):
1. âœ… AtomPub parser: Now extracts ALL CMIS properties (not just hardcoded 8)
2. âœ… Cache invalidation: checkout/cancelCheckout operations
3. âœ… deleteTree operation: Browser Binding support added
4. âœ… Versioning: cmis:document.versionable=true
5. âœ… Advanced Search: CMIS Browser Binding query syntax

## Commit & Pull Request Guidelines
- Use concise, imperative subjects. Conventional prefixes are common: `feat:`, `fix:`, `refactor:`, `chore:` (optionally add module tag, e.g., `[core] fix: ...`).
- Include context and rationale in the body; reference issues (`Fixes #123`).
- PRs should include: clear description, reproduction steps, test evidence (logs or report paths), config notes (e.g., CouchDB, ports), and any Docker compose variant used.

## Security & Configuration Tips
- Do not commit secrets. Local defaults: CouchDB `admin/password` (dev only).
- Primary config: `core/nemakiware.properties`, `docker/repositories.yml`.
- For Java 17, ensure `MAVEN_OPTS` includes required `--add-opens` (see `core/start-jetty-dev.sh`).

## Current Work Status (2025-10-25)

### Active Branch
- **Branch**: `vk/1620-ui` (merged from `origin/feature/react-ui-playwright`)
- **Related PR**: https://github.com/aegif/NemakiWare/pull/391
- **Focus**: UI test improvements and React UI enhancements

### Recent Improvements
1. **Merged 20 commits** from origin/feature/react-ui-playwright:
   - Document Versioning test improvements
   - AtomPub parser fixes
   - Cache invalidation for checkout operations
   - deleteTree operation support
   - CI/CD fixes

2. **Test Status**:
   - 69 passing (67%)
   - 4 failing (Document Versioning cleanup issues)
   - 30 skipped (UI not implemented or test issues)

### Next Steps
1. **High Priority**:
   - Fix Document Versioning test cleanup timeouts
   - Fix version history modal selector
   - Fix version download filename mismatch

2. **Medium Priority**:
   - Fix Access Control test user timeout
   - Fix Document Viewer Auth navigation issue
   - Improve CI/CD timeout handling (extend to 90 minutes)

3. **Low Priority**:
   - Implement missing UI features (Custom Type Creation, User/Group Management CRUD, etc.)
   - Complete PDF Preview functionality

### Reference Documents
- **HANDOFF-DOCUMENT.md**: Detailed session handoff with technical findings
- **PLAYWRIGHT-TEST-PROGRESS.md**: Test progress tracking
- **CLAUDE.md**: Comprehensive project documentation and history

### Quick Troubleshooting

**Docker not running**:
```bash
# Check Docker daemon status
docker ps

# If not running, start Docker Desktop (macOS) or systemctl (Linux)
# Then restart containers
cd docker && docker compose -f docker-compose-simple.yml up -d
```

**UI not accessible**:
```bash
# Verify core container is running
docker compose -f docker/docker-compose-simple.yml ps

# Check core logs
docker compose -f docker/docker-compose-simple.yml logs core

# Restart if needed
docker compose -f docker/docker-compose-simple.yml restart core
sleep 90
```

**Tests failing with timeout**:
- Check server is responding: `curl http://localhost:8080/core/ui/dist/index.html`
- Increase timeout in `playwright.config.ts`: `timeout: 60000`
- Use `--workers=1` to avoid race conditions
- Check Docker container logs for errors

**Build issues**:
```bash
# Clean rebuild
cd core/src/main/webapp/ui && npm run build
cd /path/to/NemakiWare
mvn clean package -f core/pom.xml -Pdevelopment -DskipTests

# Verify WAR file size (should be ~300MB)
ls -lh core/target/core.war
```
