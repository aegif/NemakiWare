# NemakiWare ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€£æºã‚¬ã‚¤ãƒ‰

**æœ€çµ‚æ›´æ–°**: 2025-12-09
**å¯¾è±¡**: Claude Codeã€Devinã€Cursorã€ãã®ä»–ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
**ç›®çš„**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§ã‚¹ãƒ ãƒ¼ã‚ºã«ã‚¿ã‚¹ã‚¯ã‚’å§”è­²ã§ãã‚‹ä½“åˆ¶ã‚’æ§‹ç¯‰

---

## ğŸ“Œ ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„

CLAUDE.mdã¯Claude Codeå›ºæœ‰ã®æŠ€è¡“è©³ç´°ã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™ãŒã€ã“ã®AGENTS.mdã¯**å…¨ã¦ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ãŒå‚ç…§ã§ãã‚‹æ±ç”¨çš„ãªã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ç‰¹ã«**ãƒ†ã‚¹ãƒˆã®å§”è­²**ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ã“ã¨ã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ¤ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã®æ¨å¥¨ã‚¿ã‚¹ã‚¯

### Claude Code
**å¾—æ„åˆ†é‡**: Javaãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€CMISä»•æ§˜ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- CMISã‚µãƒ¼ãƒ“ã‚¹å±¤ã®å®Ÿè£…ãƒ»ä¿®æ­£
- TCKæº–æ‹ ãƒ†ã‚¹ãƒˆã®ä¿®æ­£ãƒ»ãƒ‡ãƒãƒƒã‚°
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ã®æœ€é©åŒ–
- æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™

### Devin
**å¾—æ„åˆ†é‡**: UIãƒ†ã‚¹ãƒˆã€E2Eãƒ†ã‚¹ãƒˆã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã€ä¸¦åˆ—ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- **Playwrightãƒ†ã‚¹ãƒˆã®ä½œæˆãƒ»ä¿®æ­£**ï¼ˆæœ€é©ï¼‰
- React UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- UI/UXã®æ”¹å–„
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š

**Devinã¸ã®å§”è­²ä¾‹**:
```markdown
ã‚¿ã‚¹ã‚¯: Playwrightã‚¹ã‚­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆã®è§£é™¤
ç¯„å›²: tests/admin/custom-type-creation.spec.ts
å‰ææ¡ä»¶: ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ä½œæˆUIãŒå®Ÿè£…æ¸ˆã¿
æœŸå¾…æˆæœ: test.describe.skip â†’ test.describe ã«å¤‰æ›´ã—ã€å…¨ãƒ†ã‚¹ãƒˆé€šé
```

### Cursor
**å¾—æ„åˆ†é‡**: ã‚³ãƒ¼ãƒ‰ç·¨é›†ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¿®æ­£
**æ¨å¥¨ã‚¿ã‚¹ã‚¯**:
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- ãƒã‚°ä¿®æ­£
- TypeScriptå‹å®šç¾©ã®æ”¹å–„
- å˜ä½“ãƒ†ã‚¹ãƒˆã®ä½œæˆ

### ãã®ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
**æ±ç”¨çš„ãªã‚¿ã‚¹ã‚¯**:
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£
- QAãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ

---

## ğŸ”’ UI ãƒ‘ã‚¹çµ±ä¸€ãƒ«ãƒ¼ãƒ«ï¼ˆCRITICAL - 2025-12-09ï¼‰

**é‡è¦**: NemakiWare UI ã®å…¨ãƒ‘ã‚¹ã¯ `/core/ui/` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`/core/ui/dist/` ã¯**ç¦æ­¢**ã§ã™ã€‚

### ãƒ‘ã‚¹è¦ç´„

| æ­£ã—ã„ãƒ‘ã‚¹ | ç¦æ­¢ãƒ‘ã‚¹ |
|-----------|---------|
| `/core/ui/index.html` | `/core/ui/dist/index.html` âŒ |
| `/core/ui/oidc-callback.html` | `/core/ui/dist/oidc-callback.html` âŒ |
| `/core/ui/logo1.png` | `/core/ui/dist/logo1.png` âŒ |
| `/core/ui/assets/` | `/core/ui/dist/assets/` âŒ |

### å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| ã‚«ãƒ†ã‚´ãƒª | ãƒ•ã‚¡ã‚¤ãƒ« | ãƒã‚§ãƒƒã‚¯é …ç›® |
|---------|---------|-------------|
| **èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ** | `AuthContext.tsx` | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |
| **ä¿è­·ãƒ«ãƒ¼ãƒˆ** | `ProtectedRoute.tsx` | èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ |
| **ãƒ­ã‚°ã‚¤ãƒ³** | `login/index.html` | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URL |
| **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ** | `Layout.tsx` | ãƒ­ã‚´ãƒ‘ã‚¹ |
| **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢** | `Login.tsx` | ãƒ­ã‚´ãƒ‘ã‚¹ |
| **ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯** | `oidc-callback.html`, `saml-callback.html` | ã‚¢ã‚»ãƒƒãƒˆå‚ç…§ |
| **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«** | `tests/**/*.spec.ts` | å…¨URLå‚ç…§ |

### ãƒ‘ã‚¹å•é¡Œã®æ¤œå‡ºã‚³ãƒãƒ³ãƒ‰

```bash
# UI ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ /ui/dist/ ã‚’æ¤œç´¢ï¼ˆã‚¼ãƒ­ä»¶ãŒæ­£å¸¸ï¼‰
grep -r "/ui/dist/" core/src/main/webapp/ui/src/ --include="*.ts" --include="*.tsx"

# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ /ui/dist/ ã‚’æ¤œç´¢ï¼ˆã‚¼ãƒ­ä»¶ãŒæ­£å¸¸ï¼‰
grep -r "/ui/dist/" core/src/main/webapp/ui/tests/ --include="*.ts"

# ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£HTMLã§ /ui/dist/ ã‚’æ¤œç´¢ï¼ˆã‚¼ãƒ­ä»¶ãŒæ­£å¸¸ï¼‰
grep -r "/ui/dist/" core/src/main/webapp/ui/login/
grep -r "/ui/dist/" core/src/main/webapp/ui/public/
```

### ä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ï¼ˆå•é¡Œç™ºè¦‹æ™‚ï¼‰

```bash
# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€æ‹¬ä¿®æ­£
find core/src/main/webapp/ui/tests -name "*.ts" -exec sed -i '' 's|/ui/dist/|/ui/|g' {} \;

# ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¯å€‹åˆ¥ã«ç¢ºèªã—ã¦ä¿®æ­£
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆå§”è­²ã®ãƒ—ãƒ­ã‚»ã‚¹

### ã‚¹ãƒ†ãƒƒãƒ—1: å§”è­²å‰ã®æº–å‚™ï¼ˆå§”è­²å…ƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. ç’°å¢ƒã®å¥å…¨æ€§ç¢ºèª
docker ps                       # å…¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª
./qa-test.sh                    # QAãƒ†ã‚¹ãƒˆå…¨é€šéç¢ºèªï¼ˆ56/56ï¼‰
git status                      # ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ç¢ºèª

# 2. å¤–éƒ¨èªè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCRITICAL - å¿…é ˆï¼‰
cd core/src/main/webapp/ui
npx playwright test tests/auth/ --project=chromium
# èªè¨¼ãƒ†ã‚¹ãƒˆé€šéç¢ºèªï¼ˆ6/7ä»¥ä¸Šï¼‰

# 3. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³çµæœã®è¨˜éŒ²
npx playwright test > baseline_results.txt
# ç¾åœ¨ã®é€šéç‡ã‚’è¨˜éŒ²

# 4. å§”è­²å†…å®¹ã‚’HANDOFF.mdã«è¨˜è¼‰
```

**å§”è­²å†…å®¹ã®æ˜ç¢ºåŒ–**:
- [ ] ä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã‹ï¼ˆä¾‹: ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒ—ä½œæˆæ©Ÿèƒ½ï¼‰
- [ ] ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¯¾è±¡ã‹ï¼ˆä¾‹: tests/admin/custom-type-creation.spec.tsï¼‰
- [ ] å‰ææ¡ä»¶ã¯ä½•ã‹ï¼ˆä¾‹: UIãŒå®Ÿè£…æ¸ˆã¿ã€ã‚¹ã‚­ãƒƒãƒ—ã‚’è§£é™¤ï¼‰
- [ ] æœŸå¾…ã•ã‚Œã‚‹æˆæœç‰©ï¼ˆä¾‹: ãƒ†ã‚¹ãƒˆé€šéç‡ã®å‘ä¸Šã€ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª
docker ps                       # ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª
curl -u admin:admin http://localhost:8080/core/atom/bedroom  # ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª
cd core/src/main/webapp/ui
npx playwright --version        # Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª

# 2. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å‰ã®çŠ¶æ…‹ç¢ºèªï¼‰
npx playwright test --project=chromium

# 3. ã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆä¾‹: ã‚¹ã‚­ãƒƒãƒ—è§£é™¤ï¼‰
# ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦test.describe.skip â†’ test.describe

# 4. ãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
npx playwright test tests/admin/custom-type-creation.spec.ts --project=chromium

# 5. çµæœã®è¨˜éŒ²
npx playwright show-report
```

### ã‚¹ãƒ†ãƒƒãƒ—3: æˆæœç‰©ã®è¨˜éŒ²ï¼ˆå§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰

```bash
# 1. å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ
git add tests/admin/custom-type-creation.spec.ts
git commit -m "test: Enable custom type creation tests"

# 2. HANDOFF.mdã®æ›´æ–°
# - å®Ÿè¡Œã—ãŸãƒ†ã‚¹ãƒˆ
# - é€šé/å¤±æ•—ã®è©³ç´°
# - ç™ºè¦‹ã—ãŸãƒã‚°
# - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ææ¡ˆ

# 3. ãƒ—ãƒƒã‚·ãƒ¥
git push origin <branch-name>
```

---

## âœ… ãƒ†ã‚¹ãƒˆå§”è­²ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å§”è­²å…ƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆClaude Codeç­‰ï¼‰

**ç’°å¢ƒæº–å‚™**:
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠå…¨ã¦èµ·å‹•æ¸ˆã¿ï¼ˆ`docker ps`ã§ç¢ºèªï¼‰
- [ ] QAãƒ†ã‚¹ãƒˆå…¨é€šéï¼ˆ`./qa-test.sh` â†’ 56/56ï¼‰
- [ ] **å¤–éƒ¨èªè¨¼ãƒ†ã‚¹ãƒˆé€šé**ï¼ˆ`npx playwright test tests/auth/` â†’ 19/19ï¼‰âš ï¸ **å¿…é ˆ**
- [ ] **UIãƒ‘ã‚¹çµ±ä¸€ç¢ºèª**ï¼ˆ`grep -r "/ui/dist/"` â†’ ã‚¼ãƒ­ä»¶ï¼‰âš ï¸ **å¿…é ˆ**
- [ ] **OIDCè¨­å®šç¢ºèª**ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿JSã«`localhost:8088`ãŒå«ã¾ã‚Œã‚‹ã“ã¨ï¼‰âš ï¸ **å¿…é ˆ**
- [ ] Gitãƒ–ãƒ©ãƒ³ãƒãŒã‚¯ãƒªãƒ¼ãƒ³ï¼ˆ`git status`ï¼‰
- [ ] æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

**å§”è­²å†…å®¹ã®æ˜ç¢ºåŒ–**:
- [ ] HANDOFF.mdã«å§”è­²å†…å®¹ã‚’è¨˜è¼‰
- [ ] å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«/æ©Ÿèƒ½ã‚’ç‰¹å®š
- [ ] å‰ææ¡ä»¶ã‚’æ˜è¨˜ï¼ˆä¾‹: UIå®Ÿè£…æ¸ˆã¿ï¼‰
- [ ] æœŸå¾…æˆæœã‚’å®šç¾©ï¼ˆä¾‹: ãƒ†ã‚¹ãƒˆé€šéã€ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆï¼‰

### å§”è­²å…ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆDevinã€Cursorç­‰ï¼‰

**ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**:
- [ ] Java 17ç¢ºèªï¼ˆTCKãƒ†ã‚¹ãƒˆã®å ´åˆã®ã¿ï¼‰
- [ ] Node.js 18+ç¢ºèªï¼ˆPlaywrightãƒ†ã‚¹ãƒˆã®å ´åˆï¼‰
- [ ] Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼ˆ`npx playwright install`ï¼‰
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ç¢ºèª

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰**:
- [ ] HANDOFF.mdã‚’èª­ã‚“ã§å§”è­²å†…å®¹ã‚’ç†è§£
- [ ] BUILD_DEPLOY_GUIDE.mdã§ãƒ“ãƒ«ãƒ‰æ‰‹é †ã‚’ç¢ºèª
- [ ] ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå§”è­²å‰ã®çŠ¶æ…‹ç¢ºèªï¼‰

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œ**:
- [ ] ãƒ†ã‚¹ãƒˆçµæœã®è¨˜éŒ²ï¼ˆé€šé/å¤±æ•—ã®è©³ç´°ï¼‰
- [ ] ãƒã‚°ã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯è©³ç´°ã‚’ãƒ¬ãƒãƒ¼ãƒˆ
- [ ] å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
- [ ] HANDOFF.mdã‚’æ›´æ–°ï¼ˆæ¬¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ï¼‰

---

# Repository Guidelines

## Project Structure & Modules
- `common/` â€” Shared utilities (JAR).
- `core/` â€” CMIS REST/Web Services server (WAR, Jakarta EE 10, Spring 6).
  - `core/src/main/webapp/ui/` â€” React SPA UI (Vite + TypeScript + Ant Design)
  - `core/src/main/webapp/ui/tests/` â€” Playwright E2E tests
- `solr/` â€” Search integration helpers.
- `cloudant-init/` â€” CouchDB/Cloudant bootstrap tools.
- `docker/` â€” Compose files, images, and runtime config.
- `setup/`, `war_content/`, `WEB-INF/` â€” Installer and packaging assets.
- Tests live under `*/src/test/java`; reports under `*/test-reports/`.

## Build, Test, and Run

### Backend Build
- Build all modules: `mvn -T 1C -DskipTests install` (root `pom.xml`).
- Build server only: `mvn -pl core -am package` (produces `core/target/core.war`).
- Run dev server (Jetty 11): `cd core && ./start-jetty-dev.sh`.
  - Access CMIS: `http://localhost:8080/core/atom/bedroom` (admin:admin).
- Run tests (JUnit 4): `mvn test` or `mvn -pl core test`.

### React UI Build and Deployment

**Important**: React UI must be built and deployed to WAR file for production use.

```bash
# 1. Build React UI (from UI directory)
cd core/src/main/webapp/ui
npm install  # First time only
npm run build

# 2. Build core WAR with UI assets
cd /path/to/NemakiWare
mvn clean package -f core/pom.xml -Pdevelopment -DskipTests

# 3. Copy WAR to Docker directory
cp core/target/core.war docker/core/core.war

# 4. Deploy via Docker
cd docker
docker compose -f docker-compose-simple.yml down
docker compose -f docker-compose-simple.yml up -d --build --force-recreate

# 5. Wait for startup (ç´„90ç§’)
sleep 90

# 6. Verify UI is accessible
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/core/ui/index.html
# Expected: 200
```

### Docker Environment
- Full stack via Docker: `docker compose -f docker/docker-compose-simple.yml up -d`.
- Services: CouchDB (5984), Solr (8983), Tomcat Core (8080)
- Check status: `docker compose -f docker/docker-compose-simple.yml ps`
- View logs: `docker compose -f docker/docker-compose-simple.yml logs core`

### E2E Test Environment Setup and Prevention (2025-11-22) âš ï¸

**IMPORTANT**: Before running Playwright tests, always ensure a clean test environment to prevent failures.

**Quick Reference**:
- ğŸ“– **Full Documentation**: See `docs/e2e-test-environment.md` for comprehensive guide
- ğŸ› ï¸ **Quick Reset**: `make reset-test-env` (one-command environment reset)
- âœ… **Validation**: `make validate-env` or `scripts/validate-test-env.sh`
- ğŸ§ª **Run Tests**: `make test-e2e` (reset + validate + test)

**Common Issue - Initial Content Setup Failures**:

**Symptom**: Tests fail claiming "Sites" or "Technical Documents" folders are missing

**Root Cause**: Stale Docker volumes, incomplete initialization, or outdated images

**Solution**: Complete environment reset (see `docs/e2e-test-environment.md`)
```bash
make reset-test-env  # One-command solution
# OR manually:
mvn clean package -DskipTests
cd docker && docker-compose -f docker-compose-simple.yml build core
docker-compose -f docker-compose-simple.yml down -v  # IMPORTANT: -v wipes volumes
docker-compose -f docker-compose-simple.yml up -d    # Healthchecks enforce startup order
```

**Prevention Measures Implemented** (2025-11-22):
1. âœ… Docker Compose healthchecks (automatic startup order: CouchDB â†’ Solr â†’ Core)
2. âœ… Makefile targets for easy environment management
3. âœ… Pre-test validation script (`scripts/validate-test-env.sh`)
4. âœ… Comprehensive documentation (`docs/e2e-test-environment.md`)

**WebKit Browser Support**:
```bash
export PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS=1  # Required for Linux
```

### Playwright UI Tests

**Latest Test Results** (2025-11-22):
- **After Clean Rebuild**: Initial content setup tests now passing (5/5) âœ…
- **Previous Results** (2025-11-09): 25/25 core tests PASS
- **Known Issues**: Group management timeout, custom type UI not implemented
- See "Playwright UI Test Status (2025-11-09)" section below for details

**Running Tests**:
```bash
# Core tests (recommended for smoke testing)
cd core/src/main/webapp/ui
npx playwright test tests/basic-connectivity.spec.ts --project=chromium --workers=1
npx playwright test tests/auth/login.spec.ts --project=chromium --workers=1
npx playwright test tests/documents/document-management.spec.ts --project=chromium --workers=1

# All tests (may include long-running or skipped tests)
npx playwright test --project=chromium --workers=1

# Specific test file
npx playwright test tests/versioning/document-versioning.spec.ts --project=chromium --workers=1

# Debug mode (with browser UI)
npx playwright test --project=chromium --debug

# Generate HTML report
npx playwright show-report
```

**Test Environment Requirements**:
- Docker containers must be running (see Docker Environment section)
- Server must be healthy: `http://localhost:8080/core/ui/index.html` returns 200
- Recommended: Single worker (`--workers=1`) to avoid race conditions

## Coding Style & Naming
- Java 17; use Jakarta APIs (`jakarta.*`), avoid `javax.*`.
- Indentation: 4 spaces, UTF-8, 120-col soft wrap.
- Packages: `jp.aegif.nemaki...`; Classes `PascalCase`, methods/fields `camelCase`, constants `UPPER_SNAKE_CASE`.
- Prefer SLF4J (`org.slf4j.Logger`) over `System.out`.
- Module boundaries: put shared code in `common/`; CMIS/server code in `core/`.
- React/TypeScript: Follow standard TypeScript/React conventions, use functional components with hooks.

## Testing Guidelines

### JUnit Tests (Backend)
- Framework: JUnit 4 (Surefire configured with Java 17 module opens).
- Place tests in `src/test/java`; name files `*Test.java`.
- Keep unit tests fast and isolated (mock Solr when applicable).
- Useful scripts: `qa-test.sh`, `test-rest-api-comprehensive.sh`.

### Playwright Tests (UI)
- Framework: Playwright (TypeScript)
- Test files: `core/src/main/webapp/ui/tests/**/*.spec.ts`
- Test helpers: `tests/utils/auth-helper.ts`, `tests/utils/test-helper.ts`
- Configuration: `playwright.config.ts`

**Key Test Helpers**:
- `AuthHelper`: Login/logout, session management
- `TestHelper`: Ant Design element waiting, common UI interactions
- `uploadDocument()`: Document upload with retry logic

**Important Fixes Applied** (Historical):
1. âœ… AtomPub parser: Now extracts ALL CMIS properties (not just hardcoded 8)
2. âœ… Cache invalidation: checkout/cancelCheckout operations
3. âœ… deleteTree operation: Browser Binding support added
4. âœ… Versioning: cmis:document.versionable=true
5. âœ… Advanced Search: CMIS Browser Binding query syntax

**Current Known Issues**: See "Playwright UI Test Status (2025-11-09)" section for latest test results and known issues

## Commit & Pull Request Guidelines
- Use concise, imperative subjects. Conventional prefixes are common: `feat:`, `fix:`, `refactor:`, `chore:` (optionally add module tag, e.g., `[core] fix: ...`).
- Include context and rationale in the body; reference issues (`Fixes #123`).
- PRs should include: clear description, reproduction steps, test evidence (logs or report paths), config notes (e.g., CouchDB, ports), and any Docker compose variant used.

## Security & Configuration Tips
- Do not commit secrets. Local defaults: CouchDB `admin/password` (dev only).
- Primary config: `core/nemakiware.properties`, `docker/repositories.yml`.
- For Java 17, ensure `MAVEN_OPTS` includes required `--add-opens` (see `core/start-jetty-dev.sh`).

## Current Work Status (2025-11-09)

### Active Branch
- **Branch**: `vk/368c-tck`
- **Focus**: TCK test complete success - All 39/39 implemented CMIS features passing

### TCK Complete Success Achievement (2025-11-09) ğŸ‰

**Status**: âœ… **39/39 Tests PASS (100% of implemented features)**
**TCK Compliance**: 92.9% (39/42 tests, 3 skipped for unimplemented multi-filing feature)

| Test Group | Tests | Status | Time |
|------------|-------|--------|------|
| BasicsTestGroup | 3/3 | âœ… PASS | 24.9s |
| ConnectionTestGroup | 2/2 | âœ… PASS | 1.4s |
| TypesTestGroup | 3/3 | âœ… PASS | 172.0s |
| ControlTestGroup | 1/1 | âœ… PASS | 30.4s |
| VersioningTestGroup | 4/4 | âœ… PASS | 358.1s |
| InheritedFlagTest | 1/1 | âœ… PASS | 1.2s |
| QueryTestGroup | 6/6 | âœ… PASS | Various |
| CrudTestGroup1 | 10/10 | âœ… PASS | 35m 2s |
| CrudTestGroup2 | 9/9 | âœ… PASS | 14m 57s |
| FilingTestGroup | 0/3 | âŠ˜ SKIP | - |

**Total**: 39 tests PASS, 0 FAIL, 3 SKIP (intentional)

### Critical Fix: queryRootFolderTest (2025-11-09)

**Problem**: WHERE clause queries with explicit SELECT + aliases were missing selected properties

**Example Query**:
```sql
SELECT cmis:name AS folderName, cmis:objectId AS folderId
FROM cmis:folder
WHERE cmis:creationDate > TIMESTAMP '2012-12-31T23:00:00.000Z'
```
âŒ **Before**: Only returned objectTypeId, baseTypeId (required properties)
âœ… **After**: Returns folderName, folderId, objectTypeId, baseTypeId (all expected)

**Root Cause**: WAR file corruption/stale class files preventing Spring Bean initialization

**Solution**: Clean build + proper Docker deployment
```bash
# 1. Stop containers
docker compose -f docker/docker-compose-simple.yml down

# 2. Clean build
mvn clean package -f core/pom.xml -Pdevelopment -DskipTests

# 3. Copy WAR (verify 118MB size)
cp core/target/core.war docker/core/core.war

# 4. Force recreate containers
docker compose -f docker/docker-compose-simple.yml up -d --build --force-recreate

# 5. Wait for initialization
sleep 90
```

### Lessons Learned: Debugging Failed Approaches âš ï¸

**What NOT to Do When Debugging**:

1. âŒ **Adding System.err.println() to production code**
   - **Problem**: Caused Spring BeanCreationException
   - **Error**: `ClassNotFoundException: org.apache.chemistry.opencmis.commons.data.ObjectInFolderData`
   - **Lesson**: Even simple debug statements can break Spring class loading
   - **Better Approach**: Use existing JSON logs or remote debugger

2. âŒ **Changing logback.xml without verifying output**
   - **Problem**: DEBUG level set but no output appeared
   - **Issue**: Logger may not be initialized or output suppressed
   - **Lesson**: Always verify logging changes produce expected output

3. âŒ **Incremental rebuilds without clean**
   - **Problem**: Stale class files cause unpredictable behavior
   - **Lesson**: Always use `mvn clean` for critical fixes

**What DOES Work** âœ…:

1. âœ… **Clean build + force recreate deployment**
   - Most reliable way to eliminate build artifacts issues
   - Guarantees consistent state

2. âœ… **Analyze existing Docker JSON logs**
   - CMIS operations already produce detailed JSON logs
   - No code modifications needed

3. âœ… **Use tck-test-clean.sh for TCK tests**
   - Prevents database bloat issues
   - Provides consistent test environment

### Regression Prevention Guidelines

**Before Making Changes**:
1. Record current test status (QA: 56/56, TCK: 39/39)
2. Create git branch for changes
3. Document expected behavior

**After Making Changes**:
1. Clean build: `mvn clean package`
2. Force recreate: `docker compose down && up -d --build --force-recreate`
3. Verify QA tests: `./qa-test.sh` (should show 56/56)
4. Verify affected TCK tests
5. Commit with detailed description

**When Debugging**:
- Prefer analyzing existing logs over adding debug code
- If adding debug code is necessary, test in isolated environment first
- Always revert debug code before committing
- Document what was tried and why it failed

### Playwright UI Test Status (2025-11-09) âœ…

**Core Test Results** - All passing, no regressions from TCK work:

| Test Suite | Result | Time | Details |
|------------|--------|------|---------|
| **Basic Connectivity** | âœ… 4/4 PASS | 6.3s | UI load, backend, assets, React init |
| **Authentication** | âœ… 7/7 PASS | 23.8s | Login/logout, session, permissions |
| **Document Management** | âœ… 9/9 PASS | 2m 0s | List, upload, delete, download |
| **Initial Content Setup** | âœ… 5/5 PASS | 1.9s | Folder creation, ACL validation |

**Total**: 25/25 PASS (100%) âœ…

**Verified Functionality**:
- âœ… React app initialization and Ant Design rendering
- âœ… User authentication and session management
- âœ… CMIS Browser Binding integration (document CRUD)
- âœ… ACL permission management (multi-principal support)
- âœ… Folder hierarchy navigation

**Known Issues** (Timeouts/UI Not Implemented):

1. **group-management-crud.spec.ts** - Timeout (40+ seconds)
   - Test 1 (create group): Timeout waiting for group creation UI response
   - Tests 2-5: Skipped due to test 1 dependency
   - **Root Cause**: Group creation UI may not be implemented or extremely slow
   - **Status**: Requires UI team investigation

2. **custom-type-creation.spec.ts** - Partially Skipped
   - Test 1 (create custom type): âœ… PASS (17.2s)
   - Tests 2-3 (add properties, create document): âŠ˜ SKIP (UI elements not found)
   - **Root Cause**: Property definition tab and type selector not implemented in UI
   - **Status**: Marked as WIP in test file

3. **type-definition-upload.spec.ts** - Partially Failing
   - Test 1 (valid upload): âœ… PASS (14.3s)
   - Test 2 (conflict detection): âœ… PASS (11.9s)
   - Test 3 (JSON edit): âŒ FAIL (40.3s) - JSON edit modal timeout
   - **Root Cause**: JSON edit modal selector may have changed
   - **Status**: Requires investigation

**Impact Assessment**:
- âœ… **No TCK Regressions**: All core CMIS functionality unaffected by TCK fixes
- âœ… **No Core UI Regressions**: Essential UI features (auth, documents, ACL) working
- âš ï¸ **Admin UI Issues**: Group management and type management UI require attention

### Next Steps

1. **High Priority - TCK Maintenance**:
   - Monitor for regressions using `./qa-test.sh` (56/56) and TCK tests
   - Keep database clean for reliable test execution (`tck-test-clean.sh`)
   - Document any new CMIS features with corresponding TCK tests

2. **Medium Priority - Playwright UI Tests**:
   - âœ… **COMPLETED**: Verified core UI tests (25/25 PASS)
   - âš ï¸ Investigate group-management-crud timeout (UI implementation issue)
   - âš ï¸ Review custom-type-creation skipped tests (property tab UI missing)
   - âš ï¸ Fix type-definition-upload JSON edit modal selector

3. **Low Priority**:
   - Implement missing UI features (Group Management CRUD, Custom Type Properties)
   - Complete PDF Preview functionality
   - Improve CI/CD timeout handling

### Reference Documents
- **HANDOFF-DOCUMENT.md**: Detailed session handoff with technical findings
- **PLAYWRIGHT-TEST-PROGRESS.md**: Test progress tracking
- **CLAUDE.md**: Comprehensive project documentation and history

### Quick Troubleshooting

**Docker not running**:
```bash
# Check Docker daemon status
docker ps

# If not running, start Docker Desktop (macOS) or systemctl (Linux)
# Then restart containers
cd docker && docker compose -f docker-compose-simple.yml up -d
```

**UI not accessible**:
```bash
# Verify core container is running
docker compose -f docker/docker-compose-simple.yml ps

# Check core logs
docker compose -f docker/docker-compose-simple.yml logs core

# Restart if needed
docker compose -f docker/docker-compose-simple.yml restart core
sleep 90
```

**Tests failing with timeout**:
- Check server is responding: `curl http://localhost:8080/core/ui/index.html`
- Increase timeout in `playwright.config.ts`: `timeout: 60000`
- Use `--workers=1` to avoid race conditions
- Check Docker container logs for errors

**Build issues**:
```bash
# Clean rebuild
cd core/src/main/webapp/ui && npm run build
cd /path/to/NemakiWare
mvn clean package -f core/pom.xml -Pdevelopment -DskipTests

# Verify WAR file size (should be ~300MB)
ls -lh core/target/core.war
```
