<?xml version="1.0" encoding="UTF-8"?>
<izpack:installation version="5.0" xmlns:izpack="http://izpack.org/schema/installation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://izpack.org/schema/installation http://izpack.org/schema/5.0/izpack-installation-5.0.xsd">
  <!-- Application info -->
  <info>
    <appname>NemakiWare</appname>
    <appversion>2.4.1</appversion>
    <url>https://www.nemakiware.com/</url>
    <javaversion>1.8</javaversion>
    <!--
    If you a general user install on C:¥Program Files on Windows,
    some commands will fail. RUNAS command doesn't somehow work.
    <run-privileged condition="izpack.windowsinstall" />
    -->
  </info>

  <!-- GUI settings -->
  <guiprefs width="800" height="640" resizable="no">
    <modifier key="useButtonIcons" value="no"/>
    <modifier key="useLabelIcons" value="no"/>
    <modifier key="labelGap" value="2"/>
    <modifier key="layoutAnchor" value="NORTHWEST"/>
    <modifier key="useHeadingPanel" value="yes"/>
    <modifier key="headingImageOnLeft" value="yes"/>
    <modifier key="headingLineCount" value="1"/>
    <modifier key="headingFontSize" value="1.5"/>
    <modifier key="headingBackgroundColor" value="0x00ffffff"/>
    <modifier key="headingPanelCounter" value="text"/>
    <modifier key="headingPanelCounterPos" value="inHeading"/>
  </guiprefs>

  <!-- Available languages -->
  <locale>
    <langpack iso3="jpn" />
    <langpack iso3="eng"/>
    <langpack iso3="fra"/>
  </locale>

  <!-- Variables in this file-->
  <variables>
    <variable name="TOMCAT" value="apache-tomcat-9.0.37" />
  </variables>
  
  <!-- Dynamic variables (will be set by UserInputPanel) -->
  <dynamicvariables>
    <variable name="tomcat.port" value="8080" />
    <variable name="tomcat.shutdown.port" value="8005" />
    <variable name="cmis.repository.main" value="bedroom" />
    <variable name="db.couchdb.url" value="http://localhost:5984" />
    <variable name="db.couchdb.username" value="admin" />
    <variable name="db.couchdb.password" value="" />
    <variable name="nemaki.core.uri.host" value="localhost" />
    <variable name="nemaki.core.uri.port" value="8080" />
  </dynamicvariables>

  <!-- Resource import -->
  <resources>
    <res id="Installer.image" src="images/logo.jpg" />
    <res id="LicencePanel.licence" src="../../legal/LICENSE.txt"/>
    <res id="HTMLInfoPanel.infoCouchDB" src="resources/infoCouchDB.html"/>
    <res id="HTMLInfoPanel.infoCouchDB_jpn" src="resources/infoCouchDB_jpn.html"/>
    <res id="HTMLInfoPanel.infoCouchDB_fra" src="resources/infoCouchDB_fra.html"/>
    <res id="userInputSpec.xml" src="user-input-spec-5.xml" type="xml" parse="yes" />

    <res id="packsLang.xml_jpn" src="i18n/packsLang_jpn.xml"/>
    <res id="packsLang.xml_fra" src="i18n/packsLang_fra.xml"/>

    <res id="userInputLang.xml_jpn" src="i18n/userInputLang_jpn.xml"/>
    <res id="userInputLang.xml_fra" src="i18n/userInputLang_fra.xml"/>
  </resources>

  <!-- Conditions -->
  <conditions>
    <condition type="packselection" id="condition.pack.application.server">
      <name>pack.application.server</name>
    </condition>
    <condition type="packselection" id="condition.pack.core">
      <name>pack.core</name>
    </condition>
    <condition type="packselection" id="condition.pack.couchdb.configuration">
      <name>pack.couchdb.configuration</name>
    </condition>
    <condition type="packselection" id="condition.pack.solr">
      <name>pack.solr</name>
    </condition>
    <condition type="packselection" id="condition.pack.ui">
      <name>pack.ui</name>
    </condition>
  </conditions>

  <!-- Panels in order -->
  <panels>
    <panel classname="com.izforge.izpack.panels.hello.HelloPanel" />
    <panel classname="com.izforge.izpack.panels.licence.LicencePanel"/>
    <panel classname="com.izforge.izpack.panels.htmlinfo.HTMLInfoPanel" id="infoCouchDB" />
    <panel classname="com.izforge.izpack.panels.target.TargetPanel" />
    <panel classname="com.izforge.izpack.panels.packs.PacksPanel"/>
    <panel classname="com.izforge.izpack.panels.summary.SummaryPanel"/>
    <panel classname="com.izforge.izpack.panels.userinput.UserInputPanel" id="user.inputpanel.appserver"
      condition="condition.pack.application.server" />
    <panel classname="com.izforge.izpack.panels.userinput.UserInputPanel" id="user.inputpanel.repository"
      condition="condition.pack.core|condition.pack.couchdb.configuration" />
    <panel classname="com.izforge.izpack.panels.userinput.UserInputPanel" id="user.inputpanel.couchdb.configuration" condition="condition.pack.couchdb.configuration"/>
    <!--<panel classname="com.izforge.izpack.panels.userinput.UserInputPanel" id="user.inputpanel.solr" condition="condition.pack.solr"/>
    -->
    <panel classname="com.izforge.izpack.panels.userinput.UserInputPanel" id="user.inputpanel.ui" condition="condition.pack.ui"/>
    <panel classname="com.izforge.izpack.panels.install.InstallPanel" />
    <panel classname="com.izforge.izpack.panels.finish.FinishPanel" />
  </panels>

  <!-- Packs: Define installation files here-->
  <packs>

    <!-- Pack: Utilities -->
    <pack id="pack.utility" name="Installation utility" required="yes" hidden="true">
      <description></description>

       <!-- Import configuration scripts -->
      <file src="install-util/target/install-util.jar" targetdir="$INSTALL_PATH/setup" />
      <fileset dir="tomcat" targetdir="$INSTALL_PATH/setup/tomcat">
        <exclude name="${TOMCAT}.zip" />
      </fileset>
    </pack>

    <!-- Pack: Application server -->
    <pack id="pack.application.server" name="Tomcat" required="no">
      <description></description>

      <!-- Expand Tomcat -->
      <file src="tomcat/${TOMCAT}.zip" targetdir="$INSTALL_PATH" unpack="true" />

      <!-- Create setenv -->
      <file src="tomcat/setenv.sh" targetdir="$INSTALL_PATH/${TOMCAT}/bin" />
      <file src="tomcat/setenv.bat" targetdir="$INSTALL_PATH/${TOMCAT}/bin" />

      <!-- Create log folder-->
      <file src="tomcat/logs/catalina.out" targetdir="$INSTALL_PATH/${TOMCAT}/logs" />

      <!-- Configure tomcat -->
      <executable targetfile="$INSTALL_PATH/setup/install-util.jar" stage="postinstall" type="jar" class="jp.aegif.nemaki.installer.Facade" keep="true">
        <args>
          <arg value="config-tomcat" />
          <arg value="$INSTALL_PATH/${TOMCAT}" />
          <arg value="${tomcat.port}" />
          <arg value="${tomcat.shutdown.port}" />
          <arg value="8009" />
        </args>
      </executable>
    </pack>


    <!-- Pack: Core -->
    <pack id="pack.core" name="Core" required="no">
      <description>CMIS server</description>
      <depends packname="Tomcat" />

      <!-- Deploy WAR file -->
      <file src="../../core/target/core.war" targetdir="$INSTALL_PATH/${TOMCAT}/webapps" />

      <!-- Create general custom setting file -->
      <file src="tomcat/app-server-core.properties" targetdir="$INSTALL_PATH/${TOMCAT}/shared/classes" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/shared/classes/app-server-core.properties" type="javaprop"/>
      <file src="tomcat/app-server-core-repositories.yml" targetdir="$INSTALL_PATH/${TOMCAT}/shared/classes" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/shared/classes/app-server-core-repositories.yml"/>

      <file src="tomcat/context.xml" targetdir="$INSTALL_PATH/${TOMCAT}/conf" override="true"/>
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/conf/context.xml" type="xml"/>
    </pack>

    <!-- Pack: CouchDB configuration -->
    <pack id="pack.couchdb.configuration" name="DB initialization (with working CouchDB)" required="no">
      <description>DB initialization</description>

      <!-- Import configuration scripts -->
      <file src="../../setup/couchdb/bjornloka/target/bjornloka.jar" targetdir="$INSTALL_PATH/setup/couchdb" />
      <file src="bjornloka-wrapper.sh" targetdir="$INSTALL_PATH/setup/installer" />
      <fileset dir="../../setup/couchdb" targetdir="$INSTALL_PATH/setup/couchdb">
        <include name="initial_import/*" />
      </fileset>

      <!-- Import initial data -->
      <executable targetfile="$INSTALL_PATH/setup/installer/bjornloka-wrapper.sh" stage="postinstall"
        keep="true">
        <args>
          <arg value="$INSTALL_PATH/setup/couchdb/bjornloka.jar" />
          <arg value="${db.couchdb.url}" />
          <arg value="${db.couchdb.username}" />
          <arg value="${db.couchdb.password}" />
          <arg value="${cmis.repository.main}" />
          <arg value="${cmis.repository.main}_closet" />
          <arg value="$INSTALL_PATH/setup/couchdb/initial_import/bedroom_init.dump" />
          <arg value="$INSTALL_PATH/setup/couchdb/initial_import/archive_init.dump" />
        </args>
      </executable>

      <executable targetfile="$INSTALL_PATH/setup/installer/bjornloka-wrapper.sh" stage="postinstall"
        keep="true">
        <args>
          <arg value="$INSTALL_PATH/setup/couchdb/bjornloka.jar" />
          <arg value="${db.couchdb.url}" />
          <arg value="${db.couchdb.username}" />
          <arg value="${db.couchdb.password}" />
          <arg value="canopy" />
          <arg value="canopy_closet" />
          <arg value="$INSTALL_PATH/setup/couchdb/initial_import/canopy_init.dump" />
          <arg value="$INSTALL_PATH/setup/couchdb/initial_import/archive_init.dump" />
        </args>
      </executable>

      <!-- Create CouchDB setting file-->
      <file src="tomcat/app-server-core.properties" targetdir="$INSTALL_PATH/${TOMCAT}/shared/classes" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/shared/classes/app-server-core.properties" type="javaprop"/>
    </pack>


    <!-- Pack: Solr -->
    <pack id="pack.solr" name="Solr" required="no">
      <description>Search engine</description>
      <depends packname="Tomcat" />

      <!-- Deploy WAR file -->
      <file src="../../solr/target/solr.war" targetdir="$INSTALL_PATH/${TOMCAT}/webapps" />

      <!-- Create Solr setting file -->
      <file src="tomcat/app-server-solr.properties" targetdir="$INSTALL_PATH/${TOMCAT}/shared/classes" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/shared/classes/app-server-solr.properties" type="javaprop"/>

      <!-- Deploy Solr home -->
      <fileset dir="../../solr/solr" targetdir="$INSTALL_PATH/solr">
        <include name="**"/>
        <exclude name="**/data/*/" />
      </fileset>
      <file src="solr/app-server-solr-repositories.yml" targetdir="$INSTALL_PATH/solr" />
      <parsable targetfile="$INSTALL_PATH/solr/app-server-solr-repositories.yml"/>

      <!-- Create Solr context fragment -->
      <file src="tomcat/solr.xml" targetdir="$INSTALL_PATH/${TOMCAT}/conf/Catalina/localhost" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/conf/Catalina/localhost/solr.xml" type="xml"/>
      <file src="tomcat/nemakisolr.properties" targetdir="$INSTALL_PATH/solr/conf" />
      <parsable targetfile="$INSTALL_PATH/solr/conf/nemakisolr.properties" type="javaprop"/>

    </pack>

     <!-- Pack: UI -->
    <pack id="pack.ui" name="UI" required="no" >
      <description>CMIS client</description>
      <depends packname="Tomcat" />

      <!-- Deploy WAR file -->
      <file src="../../ui/target/ui.war" targetdir="$INSTALL_PATH/${TOMCAT}/webapps" />

      <!-- Create UI setting file -->
      <file src="tomcat/app-server-ui.properties" targetdir="$INSTALL_PATH/${TOMCAT}/shared/classes" />
      <parsable targetfile="$INSTALL_PATH/${TOMCAT}/shared/classes/app-server-ui.properties" type="javaprop"/>
    </pack>

    <!-- Pack: Test Variables -->
    <pack id="pack.test.variables" name="Test Variables" required="no" hidden="true">
      <description>Test pack for variable substitution</description>
      <file src="test-simple.properties" targetdir="$INSTALL_PATH/test" />
      <parsable targetfile="$INSTALL_PATH/test/test-simple.properties" type="javaprop"/>
    </pack>

    <!-- Pack: Delete tmp files -->
    <pack id="pack.delete.tmp" name="Delete tmp files" required="yes" hidden="true">
      <description></description>
      <executable targetfile="$INSTALL_PATH/setup/install-util.jar" stage="postinstall" type="jar" class="jp.aegif.nemaki.installer.Facade" keep="true">
        <args>
          <arg value="delete-tmp-files" />
          <arg value="$INSTALL_PATH/setup/tomcat" />
        </args>
      </executable>
    </pack>
  </packs>
</izpack:installation>
